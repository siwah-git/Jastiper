<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Keranjang - TitipGo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f3f4f6;
      margin: 0;
      padding-top: 64px;
      /* Adjust for fixed header */
    }

    .header-search {
      font-size: 1rem;
      height: 36px;
      padding-left: 2.2rem;
      padding-right: 1rem;
      border-radius: 9999px;
      width: 180px;
      font-weight: 600;
    }

    @media (min-width: 1024px) {
      .header-search {
        width: 220px;
      }
    }

    .header-search::placeholder {
      color: #a0aec0;
      opacity: 1;
      font-size: 1rem;
      font-weight: 600;
    }

    .icon-nav,
    nav svg {
      width: 28px !important;
      height: 28px !important;
      min-width: 28px;
      min-height: 28px;
    }

    .icon-nav:hover {
      filter: brightness(0.7);
    }

    .nav-center {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 2rem;
    }

    .nav-center a,
    .nav-center .dropdown-kategori>a {
      padding: 0;
      font-size: 1.25rem;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .dropdown-kategori .dropdown-content {
      min-width: 160px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
      background: #fff;
      padding: 0;
      margin-top: 4px;
      z-index: 50;
    }

    .dropdown-kategori .dropdown-content a {
      display: block;
      padding: 10px 18px;
      color: #222;
      text-decoration: none;
      font-size: 15px;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.15s, color 0.15s;
    }

    .dropdown-kategori .dropdown-content a:last-child {
      border-bottom: none;
    }

    .dropdown-kategori .dropdown-content a:hover {
      background: #f5f7fa;
      color: #1976d2;
    }

    .logo-titipgo {
      width: 112px !important;
      min-width: 112px;
      max-width: 128px;
    }

    @media (max-width: 900px) {

      .icon-nav,
      nav svg {
        width: 24px !important;
        height: 24px !important;
      }

      .logo-titipgo {
        width: 90px !important;
      }

      .header-search {
        font-size: 1rem;
        height: 36px;
        width: 180px;
      }

      .header-search::placeholder {
        font-size: 1rem;
      }

      .nav-center a,
      .nav-center .dropdown-kategori>a {
        font-size: 1rem;
      }
    }


    .keranjang-kosong {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .empty-cart-icon {
      width: 80px;
      height: 80px;
      opacity: 0.3;
      margin-bottom: 20px;
    }

    .keranjang-kosong h2 {
      font-size: 24px;
      color: #333;
      margin-bottom: 12px;
    }

    .keranjang-kosong p {
      font-size: 16px;
      color: #666;
      margin-bottom: 24px;
    }

    .btn-belanja {
      background: #1976d2;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-belanja:hover {
      background: #1256a3;
    }

    .btn-hapus-semua {
      background: #f44336;
      color: white;
      border: none;
      border-radius: 4px;
      padding: 8px 16px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-hapus-semua:hover {
      background: #d32f2f;
    }

    .keranjang-summary {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .keranjang-main {
      background: #fff;
      margin: 20px auto;
      /* Center the main content */
      max-width: 960px;
      /* Limit width for better readability */
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
      overflow: hidden;
    }

    .keranjang-content {
      padding: 20px;
    }

    .keranjang-store-section {
      margin-bottom: 20px;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      overflow: hidden;
    }

    .keranjang-store-header {
      background: #f8f9fa;
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
    }

    .keranjang-store-header input[type="checkbox"] {
      margin-right: 12px;
      width: 18px;
      height: 18px;
      accent-color: #1976d2;
    }

    .keranjang-store-name {
      font-weight: 600;
      font-size: 16px;
      color: #333;
    }

    .keranjang-item {
      display: flex;
      align-items: center;
      padding: 16px;
      border-bottom: 1px solid #f0f0f0;
      background: #fff;
    }

    .keranjang-item:last-child {
      border-bottom: none;
    }

    .keranjang-item-checkbox {
      margin-right: 16px;
    }

    .keranjang-item-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #1976d2;
    }

    .keranjang-item-image {
      margin-right: 16px;
    }

    .keranjang-item-image img {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      border: 1px solid #e0e0e0;
    }

    .keranjang-item-info {
      flex: 1;
      margin-right: 16px;
    }

    .keranjang-item-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 4px;
    }

    .keranjang-item-variant {
      font-size: 12px;
      color: #666;
    }

    .keranjang-item-price {
      font-weight: 600;
      font-size: 14px;
      color: #d32f2f;
      margin-right: 16px;
      min-width: 120px;
      text-align: right;
    }

    .keranjang-item-quantity {
      display: flex;
      align-items: center;
      margin-right: 16px;
      min-width: 100px;
      justify-content: center;
    }

    .keranjang-item-quantity button {
      width: 28px;
      height: 28px;
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .keranjang-item-quantity button:hover {
      background: #f5f5f5;
    }

    .keranjang-item-quantity span {
      margin: 0 12px;
      font-weight: 600;
      min-width: 20px;
      text-align: center;
    }

    .keranjang-item-total {
      font-weight: 600;
      font-size: 14px;
      color: #d32f2f;
      margin-right: 16px;
      min-width: 120px;
      text-align: right;
    }

    .keranjang-item-actions {
      min-width: 80px;
    }

    .keranjang-footer {
      background: #f8f9fa;
      padding: 16px 20px;
      border-top: 1px solid #e0e0e0;
    }

    .keranjang-select-all {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .keranjang-select-all input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: #1976d2;
    }

    .keranjang-select-all label {
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }

    .keranjang-total {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #333;
      font-weight: 500;
    }

    .keranjang-total span:first-child {
      font-weight: 500;
      color: #333;
    }

    .keranjang-total span:last-child {
      font-weight: bold;
      color: #d32f2f;
      font-size: 16px;
    }

    .btn-checkout {
      background: #22c100;
      color: #fff;
      border: none;
      border-radius: 18px;
      padding: 7px 24px;
      font-size: 15px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.10);
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
      margin-top: 6px;
    }

    .btn-checkout:hover {
      background: #1a9e00;
    }

    /* Modal (Popup) Styling */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #fff;
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
      transform: translateY(-20px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    .modal-overlay.show .modal-content {
      transform: translateY(0);
      opacity: 1;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 1.5rem;
      gap: 1rem;
    }

    .modal-buttons button {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .modal-buttons .btn-cancel {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
    }

    .modal-buttons .btn-cancel:hover {
      background-color: #e0e0e0;
    }

    .modal-buttons .btn-confirm {
      background-color: #ef4444;
      color: white;
      border: 1px solid #ef4444;
    }

    .modal-buttons .btn-confirm:hover {
      background-color: #dc2626;
    }

    .modal-buttons .btn-primary {
      background-color: #ec4899;
      color: white;
      border: 1px solid #ec4899;
    }

    .modal-buttons .btn-primary:hover {
      background-color: #db2777;
    }
  </style>
</head>

<body class="font-sans bg-gray-100 m-0">
  <header class="bg-white shadow-md py-1 px-6 flex justify-between items-center fixed w-full top-0 z-50 mb-8">
    <div class="flex items-center space-x-3">
      <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="w-28 sm:w-32">
      <div class="relative hidden md:block">
        <input type="text" placeholder="Cari Barang..."
          class="header-search pl-10 pr-4 py-2 border border-gray-300 rounded-full w-56 lg:w-64 focus:outline-none focus:border-pink-500">
        <svg class="w-5 h-5 absolute left-2.5 top-2.5 text-gray-500 pointer-events-none" fill="currentColor"
          viewBox="0 0 20 20">
          <path d="M8 4a4 4 0 104 4 4 4 0 00-4-4zM2 8a6 6 0 1110.39 3.94l4.3 4.3-1.42 1.42-4.3-4.3A6 6 0 012 8z">
          </path>
        </svg>
      </div>
    </div>
    <nav class="nav-center flex-grow hidden md:flex justify-center items-center gap-6">
    </nav>
    <nav class="flex items-center space-x-4 sm:space-x-6">
      <a href="pembeli_dashboard.html"
        class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Beranda</a>
      <div class="dropdown-kategori relative inline-block hidden md:block">
        <a href="pembeli_kategori.html"
          class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Kategori</a>
        <div class="dropdown-kategori relative inline-block hidden md:block"></div>
      </div>

      <a href="pembeli_keranjang.html" class="relative p-2 text-gray-700 hover:text-pink-600">
        <svg class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
          </path>
        </svg>
      </a>
      <a href="pembeli_notifikasi.html" class="relative p-2 text-gray-700 hover:text-pink-600"> <svg
          class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
          </path>
        </svg>
      </a>
      <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="User" class="icon-nav w-6 h-6" id="userIcon"
        style="cursor:pointer;">
      <div id="userDropdown"
        class="hidden absolute right-0 top-[60px] bg-white shadow-lg rounded min-w-[160px] z-[1001]">
        <a href="pembeli_akun.html"
          class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Akun Saya</a>
        <a href="pembeli_pesanan_saya.html"
          class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Pesanan</a>
        <a href="#" onclick="openChatCS();return false;"
          class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Chat dengan
          CS</a>
        <a href="#" id="tokoSayaLink"
          class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Toko Saya</a>
        <a href="#" onclick="logoutUser();return false;"
          class="block px-5 py-3 text-red-600 no-underline text-sm">Logout</a>
      </div>
    </nav>
  </header>
  <main class="pt-20">
    <h1 class="page-title"
      style="text-align:center;font-size:2rem;font-weight:bold;margin:32px 0 16px 0;letter-spacing:1px;">KERANJANG
    </h1>
    <div class="pink-bar"></div>

    <div class="keranjang-main">
      <div class="keranjang-content" id="keranjangContent">
      </div>

      <div class="keranjang-footer" id="keranjangFooter">
        <div class="keranjang-summary">
          <div class="keranjang-select-all">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            <label for="selectAll">Pilih Semua (<span id="totalProductsCount">0</span>)</label>
            <button class="btn-hapus-semua" onclick="hapusSelected()">Hapus</button>
          </div>
          <div class="keranjang-total">
            <span>Total (<span id="selectedProductsCount">0</span> Produk):</span>
            <span id="totalPrice">Rp. 0</span>
          </div>
        </div>
        <button class="btn-checkout" onclick="lanjutkanCheckout()">Checkout</button>
      </div>

      <div class="keranjang-kosong" id="keranjangKosong" style="display: none;">
        <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="Empty Cart" class="empty-cart-icon">
        <h2>Keranjang Belanja Kosong</h2>
        <p>Belum ada produk di keranjang belanja Anda.</p>
        <button class="btn-belanja" onclick="window.location.href='pembeli_dashboard.html'">Mulai
          Belanja</button>
      </div>
    </div>
  </main>

  <div id="custom-confirm-modal" class="modal-overlay">
    <div class="modal-content">
      <h3 class="text-xl font-semibold mb-4" id="custom-confirm-title">Peringatan!</h3>
      <p class="text-gray-700 mb-4" id="custom-confirm-message"></p>
      <div class="modal-buttons">
        <button id="custom-cancel-btn" class="btn-cancel hidden">Batal</button>
        <button id="custom-confirm-btn" class="btn-confirm">OK</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Perbaikan: Impor getDoc, addDoc, dan writeBatch dari firebase-config.js
    import { db, auth, onAuthStateChanged, signOut, collection, query, where, getDocs, doc, updateDoc, deleteDoc, getDoc, addDoc, writeBatch, serverTimestamp } from './js/firebase-config.js';

    let currentUserId = null;
    let cartDataFromFirebase = []; // Array to hold fetched cart items

    // Custom Confirmation/Alert Modal elements
    const customConfirmModal = document.getElementById('custom-confirm-modal');
    const customConfirmTitle = document.getElementById('custom-confirm-title');
    const customConfirmMessage = document.getElementById('custom-confirm-message');
    const customCancelBtn = document.getElementById('custom-cancel-btn');
    const customConfirmBtn = document.getElementById('custom-confirm-btn');
    let customConfirmCallback = null;

    // Function to show custom confirmation/alert modal
    function showCustomConfirm(message, callback, isConfirmation = false) {
      customConfirmMessage.textContent = message;
      customConfirmCallback = callback;
      customConfirmTitle.textContent = isConfirmation ? "Konfirmasi" : "Peringatan!";
      if (isConfirmation) {
        customConfirmBtn.classList.remove('btn-primary');
        customConfirmBtn.classList.add('btn-confirm'); // Make confirm button red for delete/logout
        customCancelBtn.classList.remove('hidden');
      } else {
        customConfirmBtn.classList.remove('btn-confirm'); // Reset to default if not confirmation
        customConfirmBtn.classList.add('btn-primary'); // Make it green for success/info
        customCancelBtn.classList.add('hidden');
      }
      customConfirmBtn.textContent = isConfirmation ? "Ya" : "OK";
      customConfirmModal.classList.add('show');
    }

    customCancelBtn.addEventListener('click', () => {
      customConfirmModal.classList.remove('show');
      customConfirmCallback = null;
    });

    customConfirmBtn.addEventListener('click', () => {
      customConfirmModal.classList.remove('show');
      if (customConfirmCallback) {
        customConfirmCallback();
      }
      customConfirmCallback = null;
    });

    // Function to format price to IDR
    function formatRupiah(number) {
      return new Intl.NumberFormat('id-ID', {
        style: 'currency',
        currency: 'IDR',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(number);
    }

    // --- Firebase Cart Functions ---
    async function fetchCartItems() {
      if (!currentUserId) {
        console.log("User not authenticated, cannot fetch cart items.");
        document.getElementById('keranjangContent').innerHTML = '';
        document.getElementById('keranjangFooter').style.display = 'none';
        document.getElementById('keranjangKosong').style.display = 'flex';
        return;
      }

      try {
        const cartRef = collection(db, "users", currentUserId, "keranjang");
        const q = query(cartRef);
        const querySnapshot = await getDocs(q);

        cartDataFromFirebase = [];
        querySnapshot.forEach(doc => {
          // Initialize 'selected' property for each item, default to true
          cartDataFromFirebase.push({ id: doc.id, ...doc.data(), selected: true });
        });
        console.log("Fetched cart items from Firebase:", cartDataFromFirebase);
        displayCart();
      } catch (error) {
        console.error("Error fetching cart items:", error);
        showCustomConfirm("Gagal memuat keranjang: " + error.message, null);
        document.getElementById('keranjangContent').innerHTML = '';
        document.getElementById('keranjangFooter').style.display = 'none';
        document.getElementById('keranjangKosong').style.display = 'flex';
      }
    }

    function displayCart() {
      const content = document.getElementById('keranjangContent');
      const footer = document.getElementById('keranjangFooter');
      const empty = document.getElementById('keranjangKosong');

      if (cartDataFromFirebase.length === 0) {
        content.innerHTML = '';
        footer.style.display = 'none';
        empty.style.display = 'flex';
        return;
      }

      empty.style.display = 'none';
      footer.style.display = 'block';

      // Group products by store
      const groupedByStore = {};
      cartDataFromFirebase.forEach(item => {
        if (!groupedByStore[item.storeId]) {
          groupedByStore[item.storeId] = {
            name: item.storeName,
            products: []
          };
        }
        groupedByStore[item.storeId].products.push(item);
      });

      let htmlContent = '';
      for (const storeId in groupedByStore) {
        const store = groupedByStore[storeId];
        // Determine if all products in this store are selected for the store checkbox
        const isStoreSelected = store.products.every(p => p.selected);

        htmlContent += `
                    <div class="keranjang-store-section" data-store-id="${storeId}">
                        <div class="keranjang-store-header">
                            <input type="checkbox" class="store-checkbox" ${isStoreSelected ? 'checked' : ''} onchange="toggleStoreSelection('${storeId}')">
                            <span class="keranjang-store-name">${store.name}</span>
                        </div>
                        ${store.products.map(product => `
                            <div class="keranjang-item" data-cart-item-id="${product.id}">
                                <div class="keranjang-item-checkbox">
                                    <input type="checkbox" class="product-checkbox" ${product.selected ? 'checked' : ''} onchange="toggleProductSelection('${product.id}')">
                                </div>
                                <div class="keranjang-item-image">
                                    <img src="${product.productImageUrl || 'https://placehold.co/60x60/E0F2F7/2C3E50?text=No+Image'}" alt="${product.productName}" onerror="this.onerror=null;this.src='https://placehold.co/60x60/E0F2F7/2C3E50?text=No+Image';">
                                </div>
                                <div class="keranjang-item-info">
                                    <div class="keranjang-item-name">${product.productName}</div>
                                    ${product.variantName ? `<div class="keranjang-item-variant">${product.variantName}</div>` : ''}
                                </div>
                                <div class="keranjang-item-price">${formatRupiah(product.price)}</div>
                                <div class="keranjang-item-quantity">
                                    <button onclick="decreaseQuantity('${product.id}')">-</button>
                                    <span>${product.quantity}</span>
                                    <button onclick="increaseQuantity('${product.id}')">+</button>
                                </div>
                                <div class="keranjang-item-total">${formatRupiah(product.price * product.quantity)}</div>
                                <div class="keranjang-item-actions">
                                    <button class="btn-hapus-semua" onclick="hapusItem('${product.id}')">Hapus</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
      }
      content.innerHTML = htmlContent;
      updateTotal();
      updateSelectAll();
    }

    window.toggleStoreSelection = function (storeId) {
      const productsInStore = cartDataFromFirebase.filter(item => item.storeId === storeId);
      const currentStoreSelection = productsInStore.every(item => item.selected); // Check current state

      productsInStore.forEach(item => {
        item.selected = !currentStoreSelection; // Toggle selection for all products in this store
      });
      displayCart(); // Re-render to update checkboxes and totals
    };

    window.toggleProductSelection = function (cartItemId) {
      const product = cartDataFromFirebase.find(item => item.id === cartItemId);
      if (product) {
        product.selected = !product.selected;
      }
      displayCart(); // Re-render to update checkboxes and totals
    };

    window.toggleSelectAll = function () {
      const selectAllCheckbox = document.getElementById('selectAll');
      const allSelected = selectAllCheckbox.checked;

      cartDataFromFirebase.forEach(item => {
        item.selected = allSelected;
      });
      displayCart(); // Re-render to update all checkboxes and totals
    };

    function updateSelectAll() {
      const selectAllCheckbox = document.getElementById('selectAll');
      const totalProductsInCart = cartDataFromFirebase.length;
      const selectedProductsInCart = cartDataFromFirebase.filter(p => p.selected).length;

      selectAllCheckbox.checked = selectedProductsInCart === totalProductsInCart && totalProductsInCart > 0;
      selectAllCheckbox.indeterminate = selectedProductsInCart > 0 && selectedProductsInCart < totalProductsInCart;

      document.getElementById('totalProductsCount').textContent = totalProductsInCart;
    }

    window.increaseQuantity = async function (cartItemId) {
      const itemRef = doc(db, "users", currentUserId, "keranjang", cartItemId);
      try {
        const itemSnap = await getDoc(itemRef);
        if (itemSnap.exists()) {
          const currentQuantity = itemSnap.data().quantity;
          // For simplicity, let's assume a max stock of 100 for now.
          // In a real app, you'd fetch actual product stock.
          // *** You'll need to fetch actual product stock to check against here ***
          const productData = await getDoc(doc(db, "produk", itemSnap.data().productId)); // Assuming productId is stored in cart item
          const availableStock = productData.exists() ? productData.data().stok : 0;

          if (currentQuantity < availableStock) { // Check against actual stock
            await updateDoc(itemRef, { quantity: currentQuantity + 1 });
            await fetchCartItems(); // Re-fetch and re-render
          } else {
            showCustomConfirm("Jumlah maksimum tercapai (Stok tersedia: " + availableStock + ").", null);
          }
        }
      } catch (error) {
        console.error("Error increasing quantity:", error);
        showCustomConfirm("Gagal menambah jumlah: " + error.message, null);
      }
    };


    window.decreaseQuantity = async function (cartItemId) {
      const itemRef = doc(db, "users", currentUserId, "keranjang", cartItemId);
      try {
        const itemSnap = await getDoc(itemRef);
        if (itemSnap.exists()) {
          const currentQuantity = itemSnap.data().quantity;
          if (currentQuantity > 1) {
            await updateDoc(itemRef, { quantity: currentQuantity - 1 });
            await fetchCartItems(); // Re-fetch and re-render
          } else {
            showCustomConfirm("Jumlah minimum adalah 1.", null);
          }
        }
      } catch (error) {
        console.error("Error decreasing quantity:", error);
        showCustomConfirm("Gagal mengurangi jumlah: " + error.message, null);
      }
    };

    window.hapusItem = function (cartItemId) {
      showCustomConfirm('Apakah Anda yakin ingin menghapus item ini?', async () => {
        try {
          await deleteDoc(doc(db, "users", currentUserId, "keranjang", cartItemId));
          showCustomConfirm("Item berhasil dihapus!", async () => {
            await fetchCartItems(); // Re-fetch and re-render
          }, false);
        } catch (error) {
          console.error("Error deleting item:", error);
          showCustomConfirm("Gagal menghapus item: " + error.message, null);
        }
      }, true);
    };

    window.hapusSelected = function () {
      const selectedItemsToDelete = cartDataFromFirebase.filter(item => item.selected);

      if (selectedItemsToDelete.length === 0) {
        showCustomConfirm('Tidak ada item yang dipilih untuk dihapus!', null);
        return;
      }

      showCustomConfirm(`Apakah Anda yakin ingin menghapus ${selectedItemsToDelete.length} item yang dipilih?`, async () => {
        try {
          const batch = writeBatch(db);
          for (const item of selectedItemsToDelete) {
            const itemRef = doc(db, "users", currentUserId, "keranjang", item.id);
            batch.delete(itemRef);
          }
          await batch.commit(); // Commit all deletions in one go

          showCustomConfirm("Item yang dipilih berhasil dihapus!", async () => {
            await fetchCartItems(); // Re-fetch and re-render
          }, false);
        } catch (error) {
          console.error("Error deleting selected items:", error);
          showCustomConfirm("Gagal menghapus item yang dipilih: " + error.message, null);
        }
      }, true);
    };

    function updateTotal() {
      let totalPrice = 0;
      let selectedCount = 0;

      cartDataFromFirebase.forEach(item => {
        if (item.selected) {
          totalPrice += item.price * item.quantity;
          selectedCount++;
        }
      });

      document.getElementById('totalPrice').textContent = formatRupiah(totalPrice);
      document.getElementById('selectedProductsCount').textContent = selectedCount;
    }

    window.lanjutkanCheckout = async function () {
      const selectedItemsForCheckout = cartDataFromFirebase.filter(item => item.selected);

      if (selectedItemsForCheckout.length === 0) {
        showCustomConfirm('Pilih minimal satu produk untuk checkout!', null);
        return;
      }

      try {
        // Prepare order data
        const orderItems = selectedItemsForCheckout.map(item => ({
          productId: item.productId,
          productName: item.productName,
          price: item.price,
          quantity: item.quantity,
          variantName: item.variantName || null,
          productImageUrl: item.productImageUrl || null,
          storeId: item.storeId,
          storeName: item.storeName,
          // Add any other relevant product details needed for the order
        }));

        const totalOrderPrice = orderItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

        const newOrderData = {
          pembeliId: currentUserId,
          items: orderItems,
          totalPrice: totalOrderPrice,
          status: 'Menunggu Pembayaran', // Initial status
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
          // You might add shipping address, payment method etc. here later
        };

        // Add the new order to the 'orders' collection
        const orderDocRef = await addDoc(collection(db, "orders"), newOrderData);
        const orderId = orderDocRef.id;

        // After successful order creation, remove these items from the user's cart
        const batch = writeBatch(db);
        for (const item of selectedItemsForCheckout) {
          const cartItemRef = doc(db, "users", currentUserId, "keranjang", item.id);
          batch.delete(cartItemRef);
        }
        await batch.commit();

        showCustomConfirm("Pesanan berhasil dibuat! Anda akan diarahkan ke halaman pembayaran.", () => {
          // Pass the orderId to the checkout page instead of the full cart data
          localStorage.setItem('currentOrderId', orderId);
          window.location.href = 'pembeli_checkout.html';
        }, false);

      } catch (error) {
        console.error("Error creating order:", error);
        showCustomConfirm("Gagal membuat pesanan: " + error.message, null);
      }
    };

    // --- Header Dropdown & Logout Functions ---
    const userIcon = document.getElementById('userIcon');
    const userDropdown = document.getElementById('userDropdown');
    const tokoSayaLink = document.getElementById('tokoSayaLink');

    userIcon.addEventListener('click', function (event) {
      event.preventDefault();
      userDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', function (event) {
      if (!userIcon.contains(event.target) && !userDropdown.contains(event.target)) {
        userDropdown.classList.add('hidden');
      }
    });

    window.logoutUser = async function () {
      try {
        await signOut(auth);
        showCustomConfirm("Anda telah logout!", () => {
          window.location.href = "index.html";
        }, false);
      } catch (error) {
        console.error("Error logging out: ", error);
        showCustomConfirm("Gagal logout. Silakan coba lagi: " + error.message, null);
      }
    };

    window.openChatCS = function () {
      showCustomConfirm('Fitur chat CS akan segera hadir!', null);
      if (userDropdown) userDropdown.classList.add('hidden');
    };

    // --- Auth State Listener ---
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUserId = user.uid;
        console.log("User authenticated:", currentUserId);

        // Check if user has a 'toko' (store) to show 'Toko Saya' link
        const userDocRef = doc(db, "users", currentUserId);
        const userDocSnap = await getDoc(userDocRef);
        if (userDocSnap.exists() && userDocSnap.data().hasStore) { // Assuming a 'hasStore' field in user doc
          tokoSayaLink.style.display = 'block';
          tokoSayaLink.href = 'jastiper_dashboard.html'; // Or relevant jastiper page
        } else {
          tokoSayaLink.style.display = 'none';
        }

        fetchCartItems();
      } else {
        currentUserId = null;
        console.log("No user authenticated.");
        // Redirect to login or show empty cart state
        showCustomConfirm("Anda harus login untuk melihat keranjang.", () => {
          window.location.href = 'login.html'; // Redirect to login page
        }, false);
      }
    });

  </script>
</body>

</html>
<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Selamat Datang di TitipGo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome untuk ikon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        xintegrity="sha512-ieCDL2m3wD6P1L3+6o5u3Q9mQ5vG7yJ+zL3F0B5W6j8U7z6T7dC4xTj8yM1Q0/6QG6r7s5E12/wA8kS/oA=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <style>
        /* Custom CSS untuk overriding atau menambahkan style Tailwind */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
        }

        .hero-section {
            transition: background-image 1s ease-in-out;
            background-size: cover;
            background-position: center;
            /* Ganti URL di bawah ini dengan path/URL gambar yang Anda lampirkan */
            background-image: url('asset/images/beranda.jpeg');
            min-height: calc(100vh - 64px);
        }

        .product-card,
        .country-card {
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            /* Menambahkan cursor pointer untuk card yang bisa diklik */
        }

        .product-card:hover,
        .country-card:hover {
            transform: translateY(-5px);
        }

        .product-card img,
        .country-card img {
            width: 100%;
            height: 160px;
            /* Tinggi produk card */
            object-fit: cover;
            border-bottom: 1px solid #eee;
        }

        /* Mengubah warna teks placeholder pada input */
        .header-search::placeholder {
            color: #a0aec0;
            opacity: 1;
        }

        .footer-logo {
            filter: brightness(0.6);
        }

        /* Style untuk ikon di header */
        .header-icon {
            color: #4a5568;
            transition: color 0.2s ease-in-out;
        }

        .header-icon:hover {
            color: #e53e3e;
        }

        /* Overlay untuk hero section */
        .hero-section .overlay-dark {
            background-color: rgba(0, 0, 0, 0.5);
        }

        /* Overlay untuk section produk best-seller */
        #produk-best-seller-section {
            background-color: #E0F2F7;
            padding: 3rem 0;
        }

        #produk-best-seller-section h2 {
            color: #2C3E50;
        }

        /* Overlay untuk section negara terpopuler */
        #negara-terpopuler-section {
            background-color: #F7FAFC;
            padding: 3rem 0;
        }

        #negara-terpopuler-section h2 {
            color: #1A202C;
        }

        /* Penyesuaian untuk teks "Apa itu TitipGo?" */
        .titipgo-description-section {
            background-color: #ffffff;
            color: #4a5568;
            padding: 2rem 1rem;
            text-align: center;
        }

        .titipgo-description-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1A202C;
        }

        .titipgo-description-section p {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
            font-size: 1rem;
            text-align: justify;
        }

        .titipgo-description-section img.logo-in-text {
            height: 2rem;
            margin: 0 0.5rem;
        }

        /* Kelas untuk menengahkan navigasi dan menambahkan jarak */
        .nav-items-group {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-items-group .nav-link {
            font-weight: 600;
            color: #4a5568;
            transition: color 0.2s ease-in-out;
        }

        .nav-items-group .nav-link:hover {
            color: #e53e3e;
        }

        .country-card {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .country-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .country-card .country-name-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 0.5rem 0;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* === Updated CSS for Masuk/Daftar Buttons === */
        .auth-button-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-button {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 600;
            text-decoration: none;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out, color 0.2s ease-in-out;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 40px;
            min-width: 90px;
        }

        .auth-button.masuk {
            background-color: #2563eb;
            color: white;
            border: 1px solid #2563eb;
        }

        .auth-button.masuk:hover {
            background-color: #1d4ed8;
            border-color: #1d4ed8;
        }

        .auth-button.daftar {
            background-color: #ec4899;
            color: white;
            border: 1px solid #ec4899;
        }

        .auth-button.daftar:hover {
            background-color: #db2777;
            border-color: #db2777;
        }

        /* Style for user profile icon/name */
        .user-profile-menu {
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-profile-menu:hover .user-name {
            color: #e53e3e;
        }
    </style>
</head>

<body class="font-sans bg-white text-gray-800">
    <header class="bg-white shadow-md py-1 px-6 flex justify-between items-center fixed w-full top-0 z-50 mb-8">
        <div class="flex items-center space-x-3">
            <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="w-28 sm:w-32">
            <div class="relative hidden md:block">
                <input type="text" placeholder="Cari Barang..."
                    class="header-search pl-10 pr-4 py-2 border border-gray-300 rounded-full w-56 lg:w-64 focus:outline-none focus:ring-pink-500 focus:border-pink-500">
                <svg class="w-5 h-5 absolute left-2.5 top-2.5 text-gray-500 pointer-events-none" fill="currentColor"
                    viewBox="0 0 20 20">
                    <path
                        d="M8 4a4 4 0 104 4 4 4 0 00-4-4zM2 8a6 6 0 1110.39 3.94l4.3 4.3-1.42 1.42-4.3-4.3A6 6 0 012 8z" />
                </svg>
            </div>
        </div>

        <!-- Grup baru untuk navigasi dan tombol autentikasi -->
        <div class="flex items-center space-x-4 sm:space-x-6">
            <nav class="nav-items-group hidden md:flex items-center gap-6">
                <a href="pembeli_dashboard.html" class="nav-link">Beranda</a>
                <div class="dropdown-kategori relative inline-block">
                    <!-- Link Kategori sekarang langsung ke pembeli_kategori.html -->
                    <a href="pembeli_kategori.html" id="kategoriMenu" class="nav-link">Kategori</a>
                    <div class="dropdown-content absolute left-0 top-full bg-white shadow-lg rounded min-w-[160px] z-10 py-2 border border-gray-200"
                        id="dropdownKategori" style="display:none;">
                        <!-- Opsi 'Produk' telah dihapus -->
                        <a href="pembeli_kategori.html"
                            class="block px-6 py-2 text-gray-900 no-underline text-sm hover:bg-gray-100 hover:text-pink-600">Pilih
                            Kategori</a>
                    </div>
                </div>
            </nav>

            <!-- Authentication buttons - HIDDEN by default, shown if not logged in -->
            <div id="authContainer" class="auth-button-container">
                <a href="login_user2.html" class="auth-button masuk">Masuk</a>
                <a href="daftar_login.html" class="auth-button daftar">Daftar</a>
            </div>

            <!-- User profile (HIDDEN by default, shown via JS after login) -->
            <!-- Bagian ini sekarang akan selalu tersembunyi sesuai permintaan -->
            <div id="userProfileContainer" class="hidden user-profile-menu">
                <img id="userAvatar" src="asset/images/default_avatar.png" alt="User Avatar"
                    class="w-10 h-10 rounded-full object-cover border-2 border-pink-500">
                <span id="userName"
                    class="user-name font-semibold text-gray-700 hover:text-pink-600 hidden md:inline-block"></span>
                <i class="fas fa-chevron-down text-gray-500 text-xs ml-1"></i>

                <div id="userDropdown"
                    class="hidden absolute right-0 top-[60px] bg-white shadow-lg rounded min-w-[160px] z-[1001] py-2 border border-gray-200">
                    <a href="pembeli_akun.html"
                        class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100 hover:bg-gray-100 hover:text-pink-600">Akun
                        Saya</a>
                    <a href="pembeli_pesanan_saya.html"
                        class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100 hover:bg-gray-100 hover:text-pink-600">Pesanan</a>
                    <a href="jastiper_dashboard.html"
                        class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100 hover:bg-gray-100 hover:text-pink-600"
                        id="tokoSayaLink">Toko Saya</a>
                    <a href="#" onclick="openChatCS();return false;"
                        class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100 hover:bg-gray-100 hover:text-pink-600">Chat
                        dengan CS</a>
                    <a href="#" onclick="logoutUser();return false;"
                        class="block px-5 py-3 text-red-600 no-underline text-sm hover:bg-gray-100">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="pt-16">
        <!-- Adjust pt-16 to clear fixed header -->
        <section id="hero-section"
            class="relative h-[80vh] flex items-center justify-center text-center px-4 hero-section">
            <div class="absolute inset-0 overlay-dark z-0"></div>
            <div class="relative z-10 text-white p-4">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">Travel Anywhere, Shop Everywhere</h1>
                <p class="text-lg md:text-xl max-w-2xl mx-auto">Solusi mudah untuk kamu yang mau belanja dari luar
                    negeri
                    dengan mudah dan aman</p>
            </div>
        </section>

        <section class="titipgo-description-section text-center">
            <h2>
                Apa itu
                <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="logo-in-text">
                Itu?
            </h2>
            <p class="text-base">
                Aplikasi TitipGo membantu kamu menemukan produk luar negeri yang kamu mau, tanpa ribet dan bisa
                langsung diantar oleh Jastiper terpercaya. Gabung dan nikmati pengalaman belanja dari berbagai negara
                hanya dalam satu aplikasi. Platform digital terbaik untuk mendukung bisnis untuk menemukan penemuan baru
                dari
                barang-barang produk unggulan. Kami siap mengantarkan Anda kemana pun Anda inginkan! TitipGo adalah
                aplikasi revolusioner yang dirancang untuk mengubah cara Anda berbelanja dari luar negeri. Dengan
                TitipGo,
                Anda dapat menemukan dan membeli produk-produk unik dari berbagai negara dengan mudah dan aman. Apakah
                Anda
                mencari fashion terbaru dari Paris, gadget inovatif dari Tokyo, atau kerajinan tangan otentik dari Bali,
                TitipGo memiliki semuanya. Kami menghubungkan Anda dengan jastiper terpercaya yang siap membantu Anda
                mendapatkan barang impian Anda tanpa kerumitan. Dengan TitipGo, belanja internasional jadi lebih mudah,
                terjangkau, dan bertanggung jawab. Kami percaya bahwa setiap orang berhak memiliki akses ke
                produk-produk
                berkualitas dari seluruh dunia, dan kami hadir untuk mewujudkannya. Titip Barang Jadi Mudah, Cari
                Jastiper
                Bawa Oleh-Oleh.
            </p>
        </section>

        <section id="produk-best-seller-section" class="relative py-12 text-center">
            <div class="relative z-10 p-4">
                <h2 class="text-3xl font-bold mb-10" id="produk-section-title">Produk</h2>
                <div id="produk-best-seller"
                    class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-6 px-4 max-w-6xl mx-auto">
                    <p id="loadingProducts" class="col-span-full text-center text-gray-500">Memuat produk...</p>
                    <p id="errorProducts" class="col-span-full text-center text-red-500 hidden">Gagal memuat produk.
                        Silakan coba lagi nanti.</p>
                    <!-- Produk akan dimuat di sini oleh JavaScript -->
                </div>
                <button id="lihat-semua-produk-button"
                    class="mt-10 bg-white text-blue-800 font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                    Lihat Semua
                </button>
            </div>
        </section>

        <section id="negara-terpopuler-section" class="py-10 text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-10">Negara</h2>
            <div id="negara-terpopuler"
                class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 px-4 max-w-6xl mx-auto">
                <p id="loadingCountries" class="col-span-full text-center text-gray-500">Memuat negara...</p>
                <p id="errorCountries" class="col-span-full text-center text-red-500 hidden">Gagal memuat negara.
                    Silakan coba lagi nanti.</p>
                <!-- Negara akan dimuat di sini oleh JavaScript -->
            </div>
            <button id="lihat-semua-negara-button"
                class="mt-10 bg-gray-900 text-white font-bold px-8 py-3 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                Lihat Semua
            </button>
        </section>
    </main>

    <footer class="bg-blue-900 py-8 px-6 mt-8">
        <div class="container mx-auto flex flex-wrap justify-between items-start text-white text-sm">
            <div class="w-full sm:w-1/3 mb-6 sm:mb-0">
                <h3 class="font-bold text-white mb-3">INFORMASI</h3>
                <ul>
                    <li class="mb-2"><a href="pembeli_tentang_kami.html" class="hover:text-pink-600">Tentang Kami</a>
                    </li>
                    <li class="mb-2"><a href="pembeli_pertanyaan_umum.html" class="hover:text-pink-600">Pertanyaan
                            Umum</a></li>
                    <li class="mb-2"><a href="pembeli_hubungi_kami.html" class="hover:text-pink-600">Hubungi Kami</a>
                    </li>
                </ul>
            </div>
            <div class="w-full sm:w-1/3 flex justify-center items-center mb-6 sm:mb-0">
                <img src="asset/images/titipgo_logo_remove.png" alt="TitipGo Logo" class="w-32">
            </div>
            <div class="w-full sm:w-1/3 text-right">
                <h3 class="font-bold text-white mb-3">IKUTI SOSIAL MEDIA KAMI</h3>
                <ul>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-instagram mr-2"></i><a
                            href="https://www.instagram.com/restiidr_?igsh=MXkwbXQ5OHgxdnJteQ%3D%3D&utm_source=qr"
                            target="_blank" class="hover:text-pink-600">Instagram</a></li>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-facebook mr-2"></i><a
                            href="https://www.instagram.com/sitiiwhy_?igsh=MTk4aWtnbTBmaWZyZQ==" target="_blank"
                            class="hover:text-pink-600">Facebook</a></li>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-youtube mr-2"></i><a
                            href="https://www.instagram.com/okay_5527?igsh=MXVkODNpNTNrZ3kwbg==" target="_blank"
                            class="hover:text-pink-600">Youtube</a></li>
                </ul>
            </div>
        </div>
        <div class="text-center text-white text-xs mt-8 opacity-75"> © 2025 TitipGo. All rights reserved.
        </div>
    </footer>
    <div id="chatCSModal"
        style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
        <div
            style="background:#fff;border-radius:12px;max-width:400px;width:90vw;padding:0 0 16px 0;box-shadow:0 4px 24px rgba(0,0,0,0.12);margin:auto;">
            <div
                style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px 20px;border-bottom:1px solid #eee;">
                <span style="font-weight:bold;font-size:17px;">Chat dengan CS</span>
                <button onclick="document.getElementById('chatCSModal').style.display='none'"
                    style="background:none;border:none;font-size:22px;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:18px 20px 0 20px;min-height:80px;">
                <div id="chatCSMessages" style="font-size:15px;color:#444;min-height:40px;"></div>
            </div>
            <div style="display:flex;align-items:center;padding:10px 20px 0 20px;gap:8px;">
                <input id="chatCSInput" type="text" placeholder="Tulis pesan..."
                    style="flex:1;padding:8px 12px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
                <button onclick="sendCSMessage()"
                    style="background:#1976d2;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:bold;cursor:pointer;">Kirim</button>
            </div>
        </div>
    </div>

    <!-- New Login Prompt Modal -->
    <div id="loginPromptModal"
        style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
        <div
            style="background:#fff;border-radius:12px;max-width:400px;width:90vw;padding:20px;box-shadow:0 4px 24px rgba(0,0,0,0.12);text-align:center;">
            <h3 style="font-weight:bold;font-size:18px;margin-bottom:15px;">Anda Harus Login Dulu!</h3>
            <p style="font-size:15px;color:#444;margin-bottom:20px;">Silakan login untuk melihat detail atau memfilter.
            </p>
            <button onclick="window.location.href='login_user2.html'"
                style="background:#ec4899;color:#fff;border:none;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;transition:background-color 0.2s;">Login
                Sekarang</button>
            <button onclick="document.getElementById('loginPromptModal').style.display='none'"
                style="background:#f0f0f0;color:#333;border:1px solid #ccc;padding:10px 20px;border-radius:8px;font-weight:bold;cursor:pointer;margin-left:10px;transition:background-color 0.2s;">Batal</button>
        </div>
    </div>

    <script type="module">
        // Import db dan fungsi-fungsi Firestore dari firebase-config.js
        import { db, auth, collection, getDocs, doc, getDoc, onAuthStateChanged, signOut } from "./js/firebase-config.js";

        // Global variable to store all products for filtering
        let allProducts = [];
        const produkSectionTitle = document.getElementById('produk-section-title');
        const lihatSemuaProdukButton = document.getElementById('lihat-semua-produk-button');
        const lihatSemuaNegaraButton = document.getElementById('lihat-semua-negara-button');

        let isLoggedIn = false; // Global flag for login status

        // Helper function to convert string to Title Case
        function toTitleCase(str) {
            if (!str) return '';
            return str.replace(/\w\S*/g, function (txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        // --- PENGATURAN SLIDER HERO SECTION ---
        const heroImages = [
            'asset/images/beranda.jpeg',
            'asset/images/Bg_beranda2.jpeg'
            // Tambahkan gambar lain jika ada
        ];

        let currentHeroImageIndex = 0;
        const heroSection = document.getElementById('hero-section');

        function changeHeroImage() {
            currentHeroImageIndex = (currentHeroImageIndex + 1) % heroImages.length;
            const nextImageUrl = heroImages[currentHeroImageIndex];
            heroSection.style.backgroundImage = `url('${nextImageUrl}')`;
        }

        setInterval(changeHeroImage, 5000); // Aktifkan slider gambar otomatis

        // --- FUNGSI DROPDOWN KATEGORI ---
        const kategoriMenu = document.getElementById('kategoriMenu');
        const dropdownKategori = document.getElementById('dropdownKategori');

        kategoriMenu.addEventListener('click', function (event) {
            dropdownKategori.style.display = dropdownKategori.style.display === 'block' ? 'none' : 'block';
        });

        document.addEventListener('click', function (event) {
            if (!kategoriMenu.contains(event.target) && !dropdownKategori.contains(event.target)) {
                dropdownKategori.style.display = 'none';
            }
        });

        // --- FUNGSI CHAT CS (tidak memerlukan login) ---
        function openChatCS() {
            document.getElementById('chatCSModal').style.display = 'flex';
            document.getElementById('chatCSMessages').innerHTML = "Halo! Ada yang bisa kami bantu?"; // Pesan awal
            document.getElementById('chatCSInput').value = ''; // Kosongkan input
        }

        function sendCSMessage() {
            const chatInput = document.getElementById('chatCSInput');
            const chatMessages = document.getElementById('chatCSMessages');
            const message = chatInput.value.trim();

            if (message !== '') {
                chatMessages.innerHTML += `<p><strong>Anda:</strong> ${message}</p>`;
                chatInput.value = '';

                setTimeout(() => {
                    chatMessages.innerHTML += `<p><strong>CS:</strong> Terima kasih atas pesan Anda. Kami akan segera merespon.</p>`;
                    chatMessages.scrollTop = chatMessages.scrollHeight; // Gulir ke bawah
                }, 1000);
            }
        }

        // --- New Login Prompt Modal Functions ---
        const loginPromptModal = document.getElementById('loginPromptModal');

        function showLoginPrompt() {
            loginPromptModal.style.display = 'flex';
        }

        // --- Handlers for Product and Country Clicks ---
        function handleProductClick(productId) {
            if (isLoggedIn) {
                window.location.href = `pembeli_detail_produk.html?id=${productId}`;
            } else {
                showLoginPrompt();
            }
        }

        function handleCountryClick(countryName) {
            if (isLoggedIn) {
                filterProductsByCountry(countryName);
            } else {
                showLoginPrompt();
            }
        }

        // Expose handlers to global scope
        window.handleProductClick = handleProductClick;
        window.handleCountryClick = handleCountryClick;
        window.openChatCS = openChatCS;
        window.sendCSMessage = sendCSMessage;

        // --- FUNGSI UNTUK MEMUAT PRODUK DARI FIRESTORE ---
        async function loadProducts() {
            const produkContainer = document.getElementById('produk-best-seller');
            const loadingMessage = document.getElementById('loadingProducts');
            const errorMessage = document.getElementById('errorProducts');

            produkContainer.innerHTML = ''; // Kosongkan konten sebelumnya
            loadingMessage.classList.remove('hidden'); // Tampilkan pesan loading
            errorMessage.classList.add('hidden'); // Sembunyikan pesan error

            try {
                const productsCollectionRef = collection(db, "produk");
                const snapshot = await getDocs(productsCollectionRef);
                const products = [];

                if (snapshot.empty) {
                    produkContainer.innerHTML = '<p class="col-span-full text-center text-gray-600">Belum ada produk yang tersedia.</p>';
                    loadingMessage.classList.add('hidden');
                    return;
                }

                snapshot.docs.slice(0, 8).forEach(doc => { // Ambil hingga 8 produk teratas
                    const product = doc.data();
                    const productCard = `
                        <div class="product-card text-black rounded-lg overflow-hidden shadow-md p-3" onclick="handleProductClick('${doc.id}')">
                            <img src="${product.imageUrl || 'https://placehold.co/160x160/E0F2F7/2C3E50?text=No+Image'}" alt="Produk ${product.namaBarang}"
                                class="w-full h-32 object-cover rounded mb-2">
                            <p class="font-semibold text-lg">${product.namaBarang}</p>
                            <span class="text-sm text-gray-500">${product.negara || 'Negara Asal'}</span>
                        </div>
                    `;
                    produkContainer.innerHTML += productCard;
                });
                loadingMessage.classList.add('hidden'); // Sembunyikan pesan loading setelah data dimuat

            } catch (error) {
                console.error("Error fetching products: ", error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorMessage.textContent = `Gagal memuat produk: ${error.message}. Silakan cek konsol browser untuk detail.`;
            }
        }

        // --- FUNGSI UNTUK MEMUAT NEGARA DARI FIRESTORE (dari koleksi 'negara') ---
        async function loadCountries() {
            const negaraContainer = document.getElementById('negara-terpopuler');
            const loadingMessage = document.getElementById('loadingCountries');
            const errorMessage = document.getElementById('errorCountries');

            negaraContainer.innerHTML = ''; // Kosongkan konten sebelumnya
            loadingMessage.classList.remove('hidden'); // Tampilkan pesan loading
            errorMessage.classList.add('hidden'); // Sembunyikan pesan error

            try {
                // Mengambil data dari koleksi 'negara'
                const negaraCollectionRef = collection(db, "negara");
                const snapshot = await getDocs(negaraCollectionRef);

                const countriesToDisplay = [];
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const countryData = doc.data();
                        // Pastikan 'nama' dan 'imageUrl' fields ada dan tidak kosong
                        if (countryData.nama && countryData.nama.trim() !== '') {
                            const normalizedCountryName = toTitleCase(countryData.nama);
                            // Gunakan imageUrl dari Firestore, jika tidak ada, gunakan placeholder "No Flag"
                            const imageUrl = countryData.imageUrl || 'https://placehold.co/160x160/F7FAFC/1A202C?text=No+Flag';
                            countriesToDisplay.push({
                                name: normalizedCountryName,
                                imageUrl: imageUrl
                            });
                        }
                    });
                }

                // Sort countries by name (optional, but good for display)
                countriesToDisplay.sort((a, b) => a.name.localeCompare(b.name));

                // Limit to 10 countries if there are more
                const limitedCountries = countriesToDisplay.slice(0, 10);

                if (limitedCountries.length === 0) {
                    negaraContainer.innerHTML = '<p class="col-span-full text-center text-gray-600">Belum ada negara yang tersedia di koleksi negara.</p>';
                    loadingMessage.classList.add('hidden');
                    return;
                }

                limitedCountries.forEach(country => {
                    const countryCard = `
                        <div class="country-card" onclick="handleCountryClick('${country.name}')">
                            <img src="${country.imageUrl}" alt="Bendera ${country.name}" onerror="this.onerror=null;this.src='https://placehold.co/160x160/F7FAFC/1A202C?text=Error+Loading+Flag';" />
                            <div class="country-name-overlay">${country.name}</div>
                        </div>
                    `;
                    negaraContainer.innerHTML += countryCard;
                });
                loadingMessage.classList.add('hidden');

            } catch (error) {
                console.error("Error fetching countries from 'negara' collection: ", error);
                loadingMessage.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorMessage.textContent = `Gagal memuat negara: ${error.message}. Pastikan URL gambar di Firestore valid.`;
            }
        }

        // New function to filter products by country (called after login)
        function filterProductsByCountry(countryName) {
            // This function would typically navigate to a category page with the country filter applied
            window.location.href = `pembeli_kategori.html?negara=${encodeURIComponent(countryName)}`;
        }

        // Event listener for "Lihat Semua" products button
        lihatSemuaProdukButton.addEventListener('click', () => {
            if (isLoggedIn) {
                window.location.href = 'pembeli_kategori.html'; // Redirect to category page
            } else {
                showLoginPrompt();
            }
        });

        // Event listener for "Lihat Semua" countries button
        lihatSemuaNegaraButton.addEventListener('click', () => {
            if (isLoggedIn) {
                window.location.href = 'pembeli_kategori.html'; // Redirect to category page
            } else {
                showLoginPrompt();
            }
        });

        // --- User Authentication and UI Updates ---
        onAuthStateChanged(auth, async (user) => {
            const authContainer = document.getElementById('authContainer');
            const userProfileContainer = document.getElementById('userProfileContainer');
            const tokoSayaLink = document.getElementById('tokoSayaLink');

            if (user) {
                // Pengguna sudah login.
                isLoggedIn = true;
                authContainer.classList.add('hidden');         // Sembunyikan tombol Masuk/Daftar
                userProfileContainer.classList.add('hidden');  // Sembunyikan avatar/profil

                // Ambil data pengguna untuk memeriksa apakah dia jastiper (untuk link "Toko Saya")
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDocSnap = await getDoc(userDocRef);

                    if (userDocSnap.exists()) {
                        const userData = userDocSnap.data();
                        if (userData.isJastiper) {
                            tokoSayaLink.style.display = 'block'; // Tampilkan link "Toko Saya" jika pengguna adalah Jastiper
                        } else {
                            tokoSayaLink.style.display = 'none'; // Sembunyikan jika bukan Jastiper
                        }
                    } else {
                        console.log("Dokumen pengguna tidak ditemukan untuk UID:", user.uid);
                        tokoSayaLink.style.display = 'none'; // Sembunyikan jika dokumen pengguna tidak ditemukan
                    }
                } catch (error) {
                    console.error("Error fetching user data for 'Toko Saya' link:", error);
                    tokoSayaLink.style.display = 'none'; // Sembunyikan jika terjadi error
                }

            } else {
                // Pengguna belum login.
                isLoggedIn = false;
                authContainer.classList.remove('hidden'); // Tampilkan tombol Masuk/Daftar
                userProfileContainer.classList.add('hidden'); // Pastikan avatar/profil tersembunyi
                tokoSayaLink.style.display = 'none'; // Pastikan link Toko Saya juga tersembunyi jika belum login
            }
        });

        // Fungsi logout
        window.logoutUser = async () => {
            try {
                await signOut(auth);
                console.log("Pengguna berhasil logout.");
                // Redirect ke halaman ini sendiri atau halaman utama lainnya untuk memperbarui UI
                window.location.href = 'pembeli_dashboard.html'; // Redirect kembali ke dashboard setelah logout
            } catch (error) {
                console.error("Error saat logout:", error);
                alert("Gagal logout. Silakan coba lagi.");
            }
        };

        // Initial calls to load products and countries
        loadProducts();
        loadCountries();
    </script>
</body>

</html>
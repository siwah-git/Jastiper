<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beranda - TitipGo</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


    <style>
        /* Custom CSS untuk overriding atau menambahkan style Tailwind */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            /* Warna background putih */
        }

        .hero-section {
            transition: background-image 1s ease-in-out;
            background-size: cover;
            background-position: center;
            /* Ganti URL di bawah ini dengan path/URL gambar yang Anda lampirkan */
            background-image: url('asset/images/beranda.jpeg');
            /* Mengatur tinggi dinamis agar mengisi sisa ruang setelah header */
            min-height: calc(100vh - 64px);
            /* Assuming header height is roughly 64px (py-1 + some height) */
            /* You might need to adjust 64px based on your actual header height */
        }

        /* If you want the hero section to always be exactly 80vh of the remaining viewport,
            you might combine with the existing h-[80vh] like this:
            height: 80vh; /* This sets its height relative to viewport height */
        /* But if you want it to fill the remaining space after header, min-height: calc() is better.
            For fixed header and content starting right after, you typically make the first section
            take up the remaining height. Let's keep h-[80vh] but ensure no top padding. */

        /* Untuk card produk dan negara agar terlihat lebih baik */
        .product-card,
        .country-card {
            background-color: #ffffff;
            /* Card background putih */
            border-radius: 0.5rem;
            /* rounded-lg */
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* shadow-md */
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            /* Add cursor pointer for clickable cards */
        }

        .product-card:hover,
        .country-card:hover {
            transform: translateY(-5px);
        }

        .product-card img,
        .country-card img {
            width: 100%;
            height: 160px;
            /* Increased height for better flag display */
            object-fit: cover;
            border-bottom: 1px solid #eee;
            /* Sedikit pemisah visual */
        }

        /* Mengubah warna teks placeholder pada input */
        .header-search::placeholder {
            color: #a0aec0;
            /* Tailwind gray-400 */
            opacity: 1;
            /* override default opacity */
        }

        .footer-logo {
            filter: brightness(0.6);
            /* Menggelapkan logo footer agar terlihat di bg abu-abu */
        }

        /* Style untuk ikon di header */
        .header-icon {
            color: #4a5568;
            /* Tailwind gray-700 */
            transition: color 0.2s ease-in-out;
        }

        .header-icon:hover {
            color: #e53e3e;
            /* Tailwind red-600, mendekati pink */
        }

        /* Overlay untuk hero section */
        .hero-section .overlay-dark {
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparan gelap */
        }

        /* Overlay untuk section produk best-seller */
        #produk-best-seller-section {
            background-color: #E0F2F7;
            /* Warna biru muda yang sesuai gambar */
            padding: 3rem 0;
        }

        #produk-best-seller-section h2 {
            color: #2C3E50;
            /* Warna teks gelap */
        }

        /* Overlay untuk section negara terpopuler */
        #negara-terpopuler-section {
            background-color: #F7FAFC;
            /* Warna putih keabu-abuan */
            padding: 3rem 0;
        }

        #negara-terpopuler-section h2 {
            color: #1A202C;
            /* Warna teks sangat gelap */
        }

        /* Penyesuaian untuk teks "Apa itu TitipGo?" */
        .titipgo-description-section {
            background-color: #ffffff;
            /* Ubah ke putih */
            color: #4a5568;
            /* Teks abu-abu gelap */
            padding: 2rem 1rem;
            text-align: center;
            /* Pastikan judul di tengah */
        }

        .titipgo-description-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1A202C;
            /* Warna teks judul */
        }

        .titipgo-description-section p {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
            /* Lebih banyak spasi baris */
            font-size: 1rem;
            text-align: justify;
            /* Rata kiri kanan untuk kerapihan */
        }

        .titipgo-description-section img.logo-in-text {
            height: 2rem;
            margin: 0 0.5rem;
        }

        /* Kelas untuk menengahkan navigasi dan menambahkan jarak */
        .nav-center {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Menambahkan jarak antar item navigasi */
            gap: 2rem;
            /* Menggunakan gap untuk jarak antar elemen flexbox */
        }

        .nav-center a {
            padding: 0;
            /* Menghilangkan padding yang sudah ada jika menggunakan gap */
        }

        .country-card {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .country-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .country-card .country-name-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent black overlay */
            color: white;
            padding: 0.5rem 0;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Styling for Chat Modal Messages */
        #chatCSMessages p {
            margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            max-width: 80%;
        }

        #chatCSMessages p strong {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.2rem;
        }

        #chatCSMessages .sender {
            background-color: #e0f7fa;
            /* Light blue for sender */
            margin-left: auto;
            text-align: right;
        }

        #chatCSMessages .receiver {
            background-color: #fce4ec;
            /* Light pink for receiver (admin) */
            margin-right: auto;
            text-align: left;
        }
    </style>
</head>

<body class="font-sans bg-white text-gray-800">
    <header class="bg-white shadow-md py-1 px-6 flex justify-between items-center fixed w-full top-0 z-50 mb-8">
        <div class="flex items-center space-x-3">
            <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="w-28 sm:w-32">
            <div class="relative hidden md:block">
                <input type="text" placeholder="Cari Barang..."
                    class="header-search pl-10 pr-4 py-2 border border-gray-300 rounded-full w-56 lg:w-64 focus:outline-none focus:border-pink-500">
                <svg class="w-5 h-5 absolute left-2.5 top-2.5 text-gray-500 pointer-events-none" fill="currentColor"
                    viewBox="0 0 20 20">
                    <path
                        d="M8 4a4 4 0 104 4 4 4 0 00-4-4zM2 8a6 6 0 1110.39 3.94l4.3 4.3-1.42 1.42-4.3-4.3A6 6 0 012 8z" />
                </svg>
            </div>
        </div>
        <nav class="nav-center flex-grow hidden md:flex justify-center items-center gap-6">
        </nav>
        <nav class="flex items-center space-x-4 sm:space-x-6">
            <a href="pembeli_dashboard.html"
                class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Beranda</a>
            <div class="dropdown-kategori relative inline-block hidden md:block">
                <a href="pembeli_kategori.html"
                    class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Kategori</a>
                <div class="dropdown-kategori relative inline-block hidden md:block"></div>
            </div>

            <a href="pembeli_keranjang.html" class="relative p-2 text-gray-700 hover:text-pink-600">
                <svg class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
            </a>
            <a href="pembeli_notifikasi.html" class="relative p-2 text-gray-700 hover:text-pink-600"> <svg
                    class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                    </path>
                </svg>
            </a>
            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="User" class="icon-nav w-6 h-6"
                id="userIcon" style="cursor:pointer;">
            <div id="userDropdown"
                class="hidden absolute right-0 top-[60px] bg-white shadow-lg rounded min-w-[160px] z-[1001]">
                <a href="pembeli_akun.html"
                    class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Akun Saya</a>
                <a href="pembeli_pesanan_saya.html"
                    class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Pesanan</a>
                <a href="#" onclick="openChatCS();return false;"
                    class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Chat dengan
                    CS</a>
                <a href="#" id="tokoSayaLink"
                    class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Toko Saya</a>
                <a href="#" onclick="logoutUser();return false;"
                    class="block px-5 py-3 text-red-600 no-underline text-sm">Logout</a>
            </div>
        </nav>
    </header>
    <main class="mt-16">
        <section id="hero-section"
            class="relative h-[80vh] flex items-center justify-center text-center px-4 hero-section">
            <div class="absolute inset-0 overlay-dark z-0"></div>
            <div class="relative z-10 text-white p-4">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">Travel Anywhere, Shop Everywhere</h1>
                <p class="text-lg md:text-xl max-w-2xl mx-auto">Solusi mudah untuk kamu yang mau belanja dari luar
                    negeri
                    dengan mudah dan aman</p>
            </div>
        </section>

        <section class="titipgo-description-section text-center">
            <h2>
                Apa itu
                <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="logo-in-text">
                Itu?
            </h2>
            <p class="text-base">
                Aplikasi TitipGo membantu kamu menemukan produk luar negeri yang kamu mau, tanpa ribet dan bisa langsung
                diantar oleh Jastiper terpercaya. Gabung dan nikmati pengalaman belanja dari berbagai negara hanya dalam
                satu aplikasi. Platform digital terbaik untuk mendukung bisnis untuk menemukan penemuan baru dari
                barang-barang produk unggulan. Kami siap mengantarkan Anda kemana pun Anda inginkan! TitipGo adalah
                aplikasi revolusioner yang dirancang untuk mengubah cara Anda berbelanja dari luar negeri. Dengan
                TitipGo,
                Anda dapat menemukan dan membeli produk-produk unik dari berbagai negara dengan mudah dan aman. Apakah
                Anda
                mencari fashion terbaru dari Paris, gadget inovatif dari Tokyo, atau kerajinan tangan otentik dari Bali,
                TitipGo memiliki semuanya. Kami menghubungkan Anda dengan jastiper terpercaya yang siap membantu Anda
                mendapatkan barang impian Anda tanpa kerumitan. Dengan TitipGo, belanja internasional jadi lebih mudah,
                terjangkau, dan bertanggung jawab. Kami percaya bahwa setiap orang berhak memiliki akses ke
                produk-produk
                berkualitas dari seluruh dunia, dan kami hadir untuk mewujudkannya. Titip Barang Jadi Mudah, Cari
                Jastiper
                Bawa Oleh-Oleh.
            </p>
        </section>

        <section id="produk-best-seller-section" class="relative py-12 text-center">
            <div class="relative z-10 p-4">
                <h2 class="text-3xl font-bold mb-10" id="produk-section-title">Produk</h2>
                <div id="produk-best-seller"
                    class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-6 px-4 max-w-6xl mx-auto">
                    <p id="loading-products" class="col-span-full text-gray-500">Memuat produk...</p>
                    <p id="no-products-found" class="col-span-full text-gray-500 hidden">Tidak ada produk ditemukan.</p>
                </div>
                <button id="lihat-semua-produk-button"
                    class="mt-10 bg-white text-blue-800 font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                    Lihat Semua
                </button>
            </div>
        </section>

        <section id="negara-terpopuler-section" class="py-10 text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-10">Negara</h2>
            <div id="negara-terpopuler"
                class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 px-4 max-w-6xl mx-auto">
                <p id="loading-countries" class="col-span-full text-gray-500">Memuat negara...</p>
                <p id="no-countries-found" class="col-span-full text-gray-500 hidden">Tidak ada negara ditemukan.</p>
            </div>
            <button id="lihat-semua-negara-button"
                class="mt-10 bg-gray-900 text-white font-bold px-8 py-3 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                Lihat Semua
            </button>
        </section>
    </main>

    <footer class="bg-blue-900 py-8 px-6 mt-8">
        <div class="container mx-auto flex flex-wrap justify-between items-start text-white text-sm">
            <div class="w-full sm:w-1/3 mb-6 sm:mb-0">
                <h3 class="font-bold text-white mb-3">INFORMASI</h3>
                <ul>
                    <li class="mb-2"><a href="pembeli_tentang_kami.html" class="hover:text-pink-600">Tentang Kami</a>
                    </li>
                    <li class="mb-2"><a href="pembeli_pertanyaan_umum.html" class="hover:text-pink-600">Pertanyaan
                            Umum</a></li>
                    <li class="mb-2"><a href="pembeli_hubungi_kami.html" class="hover:text-pink-600">Hubungi Kami</a>
                    </li>
                </ul>
            </div>
            <div class="w-full sm:w-1/3 flex justify-center items-center mb-6 sm:mb-0">
                <img src="asset/images/titipgo_logo_remove.png" alt="TitipGo Logo" class="w-32">
            </div>
            <div class="w-full sm:w-1/3 text-right">
                <h3 class="font-bold text-white mb-3">IKUTI SOSIAL MEDIA KAMI</h3>
                <ul>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-instagram mr-2"></i><a
                            href="https://www.instagram.com/restiidr_?igsh=MXkwbXQ5OHgxdnJteQ%3D%3D&utm_source=qr"
                            target="_blank" class="hover:text-pink-600">Instagram</a></li>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-facebook mr-2"></i><a
                            href="https://www.instagram.com/sitiiwhy_?igsh=MTk4aWtnbTBmaWZyZQ==" target="_blank"
                            class="hover:text-pink-600">Facebook</a></li>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-youtube mr-2"></i><a
                            href="https://www.instagram.com/okay_5527?igsh=MXVkODNpNTNrZ3kwbg==" target="_blank"
                            class="hover:text-pink-600">Youtube</a></li>
                </ul>
            </div>
        </div>
        <div class="text-center text-white text-xs mt-8 opacity-75"> Â© 2025 TitipGo. All rights reserved.
        </div>
    </footer>
    <div id="chatCSModal"
        style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
        <div
            style="background:#fff;border-radius:12px;max-width:400px;width:90vw;padding:0 0 16px 0;box-shadow:0 4px 24px rgba(0,0,0,0.12);margin:auto;">
            <div
                style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px 20px;border-bottom:1px solid #eee;">
                <span style="font-weight:bold;font-size:17px;">Chat dengan CS</span>
                <button onclick="document.getElementById('chatCSModal').style.display='none'"
                    style="background:none;border:none;font-size:22px;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:18px 20px 0 20px;min-height:80px; max-height: 300px; overflow-y: auto;">
                <div id="chatCSMessages" style="font-size:15px;color:#444;min-height:40px;"></div>
            </div>
            <div style="display:flex;align-items:center;padding:10px 20px 0 20px;gap:8px;">
                <input id="chatCSInput" type="text" placeholder="Tulis pesan..."
                    style="flex:1;padding:8px 12px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
                <button onclick="sendCSMessage()"
                    style="background:#1976d2;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:bold;cursor:pointer;">Kirim</button>
            </div>
        </div>
    </div>
    <script type="module">
        // Import Firebase modules from your firebase-config.js
        import { db, auth, collection, getDocs, query, where, doc, getDoc, onAuthStateChanged, signOut, setDoc, updateDoc, serverTimestamp, onSnapshot, addDoc } from "/js/firebase-config.js";

        // Global variable to store all products for filtering
        let allProducts = [];
        const produkSectionTitle = document.getElementById('produk-section-title');
        const lihatSemuaProdukButton = document.getElementById('lihat-semua-produk-button');
        const lihatSemuaNegaraButton = document.getElementById('lihat-semua-negara-button'); // Added this line
        // Global map to store country images fetched from Firestore
        const firestoreCountryImagesMap = new Map();

        // Helper function to convert string to Title Case
        function toTitleCase(str) {
            if (!str) return '';
            return str.replace(/\w\S*/g, function (txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        // --- PENGATURAN SLIDER HERO SECTION ---
        const heroImages = [
            'asset/images/beranda.jpeg',
            'asset/images/Bg_beranda2.jpeg'
            // Tambahkan gambar lain jika ada
        ];

        let currentHeroImageIndex = 0;
        const heroSection = document.getElementById('hero-section');

        function changeHeroImage() {
            currentHeroImageIndex = (currentHeroImageIndex + 1) % heroImages.length;
            const nextImageUrl = heroImages[currentHeroImageIndex];
            heroSection.style.backgroundImage = `url('${nextImageUrl}')`;
        }

        // Panggil fungsi untuk mengubah gambar setiap beberapa detik (misalnya 5 detik)
        setInterval(changeHeroImage, 5000); // Aktifkan slider gambar otomatis

        // --- FUNGSI DROPDOWN MENU ---
        const userIcon = document.getElementById('userIcon');
        const userDropdown = document.getElementById('userDropdown');
        const tokoSayaLink = document.getElementById('tokoSayaLink'); // Get the "Toko Saya" link

        // Hide user dropdown by default
        userDropdown.classList.add('hidden');

        userIcon.addEventListener('click', function (event) {
            event.preventDefault(); // Mencegah link default action
            userDropdown.classList.toggle('hidden');
        });

        // Tutup dropdown jika klik di luar area dropdown
        document.addEventListener('click', function (event) {
            if (!userIcon.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Fungsi Logout
        async function logoutUser() {
            try {
                await signOut(auth); // Perform Firebase logout
                alert("Anda telah logout!"); // Use custom modal for alerts later
                window.location.href = "index.html"; // Redirect to login page after logout
            } catch (error) {
                console.error("Error logging out: ", error);
                alert("Gagal logout. Silakan coba lagi."); // Use custom modal for alerts later
            }
        }

        // --- FUNGSI CHAT DENGAN CS ---
        const chatCSModal = document.getElementById('chatCSModal');
        const chatCSMessages = document.getElementById('chatCSMessages');
        const chatCSInput = document.getElementById('chatCSInput');

        // Ganti dengan UID admin yang sebenarnya di aplikasi Anda
        // Anda bisa mengambil ini dari konfigurasi atau dari dokumen Firestore yang spesifik.
        const ADMIN_UID = "YOUR_ADMIN_FIREBASE_UID_HERE"; // !!! PENTING: GANTI INI DENGAN UID ADMIN ASLI ANDA !!!

        let currentUserUid = null;
        let userChatRoomId = null; // Untuk menyimpan ID ruang chat spesifik antara user dan admin

        // Fungsi untuk mendapatkan atau membuat ruang chat
        async function getOrCreateChatRoom(userUid, adminUid) {
            // Logika sederhana: ID ruang chat adalah gabungan UID user dan admin, diurutkan untuk konsistensi
            const chatRoomIdentifier = [userUid, adminUid].sort().join('-');
            const chatRoomRef = doc(db, "chat", chatRoomIdentifier);
            const chatRoomSnap = await getDoc(chatRoomRef);

            if (!chatRoomSnap.exists()) {
                console.log("Membuat ruang chat baru...");
                await setDoc(chatRoomRef, {
                    members: [userUid, adminUid],
                    createdAt: serverTimestamp(),
                    lastMessageAt: serverTimestamp()
                });
            } else {
                console.log("Ruang chat sudah ada.");
            }
            return chatRoomIdentifier;
        }

        // Fungsi untuk menampilkan pesan ke UI modal chat
        function displayChatMessage(messageData) {
            const messageElement = document.createElement('p');
            const senderName = messageData.senderId === currentUserUid ? "Anda" : "CS";

            messageElement.innerHTML = `<strong>${senderName}:</strong> ${messageData.message}`;
            messageElement.classList.add('mb-2', 'p-2', 'rounded-lg', 'max-w-[80%]');

            if (messageData.senderId === currentUserUid) {
                messageElement.classList.add('bg-pink-100', 'ml-auto', 'text-right');
            } else {
                messageElement.classList.add('bg-gray-200', 'mr-auto', 'text-left');
                // Tandai pesan sebagai terbaca jika itu dari CS dan belum terbaca
                if (messageData.status === 'unread' && userChatRoomId) {
                    updateDoc(doc(db, "chat", userChatRoomId, "messages", messageData.id), { // use messageData.id
                        status: "read"
                    });
                }
            }
            chatCSMessages.appendChild(messageElement);
            chatCSMessages.scrollTop = chatCSMessages.scrollHeight; // Gulir ke bawah
        }

        // Fungsi untuk membuka modal chat CS
        async function openChatCS() {
            if (!auth.currentUser) {
                alert("Anda harus login untuk chat dengan CS.");
                return;
            }

            currentUserUid = auth.currentUser.uid;
            chatCSModal.style.display = 'flex';
            chatCSMessages.innerHTML = ''; // Kosongkan pesan sebelumnya

            // Dapatkan atau buat ruang chat
            userChatRoomId = await getOrCreateChatRoom(currentUserUid, ADMIN_UID);

            // Set up real-time listener for messages in this chat room
            const messagesRef = collection(db, "chat", userChatRoomId, "messages");
            const q = query(messagesRef, orderBy("timestamp", "asc"));

            onSnapshot(q, (snapshot) => {
                // Clear previous messages if it's the initial load or a reset
                // Only re-render added messages to avoid flicker
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const messageData = { id: change.doc.id, ...change.doc.data() };
                        displayChatMessage(messageData);
                    } else if (change.type === "modified") {
                        // Handle modifications, e.g., status changes
                        // You might re-render specific message or update its style
                        console.log("Modified message:", change.doc.data());
                    }
                });
            }, (error) => {
                console.error("Error fetching chat messages:", error);
                chatCSMessages.innerHTML = `<p style="color:red;">Gagal memuat pesan: ${error.message}</p>`;
            });
        }

        // Fungsi untuk mengirim pesan ke CS
        async function sendCSMessage() {
            const messageText = chatCSInput.value.trim();

            if (messageText === "") {
                alert("Pesan tidak boleh kosong!");
                return;
            }

            if (!currentUserUid || !userChatRoomId) {
                alert("Kesalahan: Pengguna tidak login atau ruang chat belum siap.");
                return;
            }

            try {
                const messagesCollectionRef = collection(db, "chat", userChatRoomId, "messages");
                await addDoc(messagesCollectionRef, {
                    senderId: currentUserUid,
                    receiverId: ADMIN_UID,
                    message: messageText,
                    timestamp: serverTimestamp(),
                    status: "unread" // Pesan baru selalu "unread" secara default
                });
                chatCSInput.value = ''; // Kosongkan input setelah kirim

                // Opsional: Perbarui lastMessageAt di dokumen chat room induk
                await updateDoc(doc(db, "chat", userChatRoomId), {
                    lastMessageAt: serverTimestamp()
                });

            } catch (error) {
                console.error("Error sending message:", error);
                alert("Gagal mengirim pesan: " + error.message);
            }
        }

        // Event listener untuk tombol Enter di input pesan chat
        chatCSInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendCSMessage();
            }
        });

        // Expose functions to global scope for onclick attributes
        window.logoutUser = logoutUser;
        window.openChatCS = openChatCS;
        window.sendCSMessage = sendCSMessage;

        // --- Firebase Data Fetching and Rendering ---
        const produkBestSellerContainer = document.getElementById('produk-best-seller');
        const negaraTerpopulerContainer = document.getElementById('negara-terpopuler');
        const loadingProductsMessage = document.getElementById('loading-products');
        const noProductsFoundMessage = document.getElementById('no-products-found');
        const loadingCountriesMessage = document.getElementById('loading-countries');
        const noCountriesFoundMessage = document.getElementById('no-countries-found');

        async function fetchProductsAndCountries() {
            produkBestSellerContainer.innerHTML = ''; // Clear existing content
            negaraTerpopulerContainer.innerHTML = ''; // Clear existing content
            loadingProductsMessage.classList.remove('hidden');
            noProductsFoundMessage.classList.add('hidden');
            loadingCountriesMessage.classList.remove('hidden');
            noCountriesFoundMessage.classList.add('hidden');

            try {
                // Fetch products
                const productsCollectionRef = collection(db, "produk");
                const productsSnapshot = await getDocs(productsCollectionRef);
                const products = [];
                const countriesFromProducts = new Set();

                if (!productsSnapshot.empty) {
                    productsSnapshot.forEach((doc) => {
                        const productData = doc.data();
                        // Normalize country name from product data
                        const normalizedCountry = toTitleCase(productData.negara);
                        products.push({ id: doc.id, ...productData, negara: normalizedCountry });
                        if (normalizedCountry) {
                            countriesFromProducts.add(normalizedCountry);
                        }
                    });
                }

                allProducts = products; // Store all fetched products globally
                renderProducts(allProducts); // Render all products initially

                // Fetch countries from 'negara' collection (if it exists)
                const allCountries = new Set();
                firestoreCountryImagesMap.clear(); // Clear previous data

                try {
                    const negaraCollectionRef = collection(db, "negara");
                    const negaraSnapshot = await getDocs(negaraCollectionRef);
                    if (!negaraSnapshot.empty) {
                        negaraSnapshot.forEach((doc) => {
                            const countryData = doc.data();
                            // Use 'nama' field for country name as requested
                            if (countryData.nama) {
                                // Normalize country name from negara collection
                                const normalizedCountryName = toTitleCase(countryData.nama);
                                allCountries.add(normalizedCountryName);
                                if (countryData.imageUrl) { // Check if imageUrl exists
                                    firestoreCountryImagesMap.set(normalizedCountryName, countryData.imageUrl);
                                }
                            }
                        });
                    }
                } catch (error) {
                    console.warn("Koleksi 'negara' tidak ditemukan atau error saat mengambil data:", error);
                    // Jika koleksi 'negara' tidak ada atau ada error, kita akan tetap menggunakan negara dari produk
                }

                // Combine countries from 'negara' collection and 'produk' collection
                const finalCountries = Array.from(new Set([...allCountries, ...countriesFromProducts]));
                renderCountries(finalCountries);

            } catch (error) {
                console.error("Error fetching products or countries:", error);
                loadingProductsMessage.classList.add('hidden');
                noProductsFoundMessage.textContent = "Gagal memuat produk: " + error.message;
                noProductsFoundMessage.classList.remove('hidden');
                loadingCountriesMessage.classList.add('hidden');
                noCountriesFoundMessage.textContent = "Gagal memuat negara: " + error.message;
                noCountriesFoundMessage.classList.remove('hidden');
            }
        }

        function renderProducts(productsToRender) {
            loadingProductsMessage.classList.add('hidden');
            produkBestSellerContainer.innerHTML = ''; // Clear again before rendering

            if (productsToRender.length === 0) {
                noProductsFoundMessage.classList.remove('hidden');
                return;
            }

            productsToRender.forEach(product => {
                const productCard = `
                    <div class="product-card text-black rounded-lg overflow-hidden shadow-md p-3" onclick="viewProductDetail('${product.id}')">
                        <img src="${product.imageUrl || 'https://placehold.co/128x128/E0F2F7/2C3E50?text=No+Image'}" alt="${product.namaBarang}"
                            class="w-full h-32 object-cover rounded mb-2">
                        <p class="font-semibold text-lg">${product.namaBarang || 'Nama Produk'}</p>
                        <span class="text-sm text-gray-500">${product.merk || ''} - ${product.negara || 'Negara Asal'}</span>
                    </div>
                `;
                produkBestSellerContainer.innerHTML += productCard;
            });
        }

        function renderCountries(countries) {
            loadingCountriesMessage.classList.add('hidden');
            negaraTerpopulerContainer.innerHTML = ''; // Clear again before rendering

            if (countries.length === 0) {
                noCountriesFoundMessage.classList.remove('hidden');
                return;
            }

            countries.forEach(country => {
                // Strictly prioritize imageUrl from Firestore, then generic placeholder
                const imageUrl = firestoreCountryImagesMap.get(country) || 'https://placehold.co/160x160/F7FAFC/1A202C?text=No+Flag';

                // Log the country name and image URL being used for debugging
                console.log(`Rendering country: ${country}, Image URL: ${imageUrl}`);

                const countryCard = `
                    <div class="country-card" onclick="filterProductsByCountry('${country}')">
                        <img src="${imageUrl}" alt="${country}" onerror="this.onerror=null;this.src='https://placehold.co/160x160/F7FAFC/1A202C?text=Error+Loading+Flag';" />
                        <div class="country-name-overlay">${country}</div>
                    </div>
                `;
                negaraTerpopulerContainer.innerHTML += countryCard;
            });
        }

        // New function to filter products by country
        function filterProductsByCountry(countryName) {
            const filtered = allProducts.filter(product => product.negara === countryName);
            produkSectionTitle.textContent = `Produk dari ${countryName}`;
            renderProducts(filtered);
            lihatSemuaProdukButton.classList.remove('hidden'); // Ensure "Lihat Semua" button is visible
        }

        // New function to navigate to product detail page
        function viewProductDetail(productId) {
            window.location.href = `pembeli_produk.html?id=${productId}`; // Changed to pembeli_produk.html
        }

        // Expose viewProductDetail globally
        window.viewProductDetail = viewProductDetail;
        window.filterProductsByCountry = filterProductsByCountry; // Expose this too for onclick in country cards

        // Event listener for "Lihat Semua Produk" button
        lihatSemuaProdukButton.addEventListener('click', () => { // Corrected typo here
            produkSectionTitle.textContent = "Produk"; // Reset title
            renderProducts(allProducts); // Show all products
            lihatSemuaProdukButton.classList.add('hidden'); // Hide the button after showing all
        });

        // Initial fetch when the page loads
        document.addEventListener('DOMContentLoaded', fetchProductsAndCountries);

        // Check user authentication status on page load to adjust UI (e.g., "Toko Saya" link)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUserUid = user.uid; // Set currentUserUid when user is logged in
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    const userData = userDocSnap.data();
                    if (userData.role === 'jastiper') {
                        tokoSayaLink.href = "jastiper_dashboard.html"; // Link to Jastiper dashboard if role is jastiper
                    } else {
                        tokoSayaLink.href = "jastiper_daftar_toko.html"; // Link to register store if not jastiper
                    }
                } else {
                    tokoSayaLink.href = "jastiper_daftar_toko.html"; // Default to register if user doc not found
                }
            } else {
                // User is signed out
                tokoSayaLink.href = "jastiper_daftar_toko.html"; // Redirect to register if not logged in
                // Optionally hide user icon or show login/register links
            }
        });
    </script>
</body>

</html>
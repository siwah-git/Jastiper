<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Beranda - TitipGo</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />


    <style>
        /* Custom CSS untuk overriding atau menambahkan style Tailwind */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #ffffff;
            /* Warna background putih */
        }

        .hero-section {
            transition: background-image 1s ease-in-out;
            background-size: cover;
            background-position: center;
            /* Ganti URL di bawah ini dengan path/URL gambar yang Anda lampirkan */
            background-image: url('asset/images/beranda.jpeg');
            /* Mengatur tinggi dinamis agar mengisi sisa ruang setelah header */
            min-height: calc(100vh - 64px);
            /* Assuming header height is roughly 64px (py-1 + some height) */
            /* You might need to adjust 64px based on your actual header height */
            /* If you want the hero section to always be exactly 80vh of the remaining viewport,
            you might combine with the existing h-[80vh] like this:
            height: 80vh; /* This sets its height relative to viewport height */
            /* But if you want it to fill the remaining space after header, min-height: calc() is better.
            For fixed header and content starting right after, you typically make the first section
            take up the remaining height. Let's keep h-[80vh] but ensure no top padding. */

        }

        /* Untuk card produk dan negara agar terlihat lebih baik */
        .product-card,
        .country-card {
            background-color: #ffffff;
            /* Card background putih */
            border-radius: 0.5rem;
            /* rounded-lg */
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            /* shadow-md */
            transition: transform 0.2s ease-in-out;
            cursor: pointer;
            /* Add cursor pointer for clickable cards */
        }

        .product-card:hover,
        .country-card:hover {
            transform: translateY(-5px);
        }

        .product-card img,
        .country-card img {
            width: 100%;
            height: 160px;
            /* Increased height for better flag display */
            object-fit: cover;
            border-bottom: 1px solid #eee;
            /* Sedikit pemisah visual */
        }

        /* Mengubah warna teks placeholder pada input */
        .header-search::placeholder {
            color: #a0aec0;
            /* Tailwind gray-400 */
            opacity: 1;
            /* override default opacity */
        }

        .footer-logo {
            filter: brightness(0.6);
            /* Menggelapkan logo footer agar terlihat di bg abu-abu */
        }

        /* Style untuk ikon di header */
        .header-icon {
            color: #4a5568;
            /* Tailwind gray-700 */
            transition: color 0.2s ease-in-out;
        }

        .header-icon:hover {
            color: #e53e3e;
            /* Tailwind red-600, mendekati pink */
        }

        /* Overlay untuk hero section */
        .hero-section .overlay-dark {
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparan gelap */
        }

        /* Overlay untuk section produk best-seller */
        #produk-best-seller-section {
            background-color: #E0F2F7;
            /* Warna biru muda yang sesuai gambar */
            padding: 3rem 0;
        }

        #produk-best-seller-section h2 {
            color: #2C3E50;
            /* Warna teks gelap */
        }

        /* Overlay untuk section negara terpopuler */
        #negara-terpopuler-section {
            background-color: #F7FAFC;
            /* Warna putih keabu-abuan */
            padding: 3rem 0;
        }

        #negara-terpopuler-section h2 {
            color: #1A202C;
            /* Warna teks sangat gelap */
        }

        /* Penyesuaian untuk teks "Apa itu TitipGo?" */
        .titipgo-description-section {
            background-color: #ffffff;
            /* Ubah ke putih */
            color: #4a5568;
            /* Teks abu-abu gelap */
            padding: 2rem 1rem;
            text-align: center;
            /* Pastikan judul di tengah */
        }

        .titipgo-description-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1A202C;
            /* Warna teks judul */
        }

        .titipgo-description-section p {
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.7;
            /* Lebih banyak spasi baris */
            font-size: 1rem;
            text-align: justify;
            /* Rata kiri kanan untuk kerapihan */
        }

        .titipgo-description-section img.logo-in-text {
            height: 2rem;
            margin: 0 0.5rem;
        }

        /* Kelas untuk menengahkan navigasi dan menambahkan jarak */
        .nav-center {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Menambahkan jarak antar item navigasi */
            gap: 2rem;
            /* Menggunakan gap untuk jarak antar elemen flexbox */
        }

        .nav-center a {
            padding: 0;
            /* Menghilangkan padding yang sudah ada jika menggunakan gap */
        }

        .country-card {
            position: relative;
            background-color: #ffffff;
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .country-card img {
            width: 100%;
            height: 160px;
            object-fit: cover;
            display: block;
        }

        .country-card .country-name-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.5);
            /* Semi-transparent black overlay */
            color: white;
            padding: 0.5rem 0;
            text-align: center;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* Styling for Chat Modal Messages (Re-added) */
        #chatCSMessages p {
            margin-bottom: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 8px;
            max-width: 80%;
        }

        #chatCSMessages p strong {
            display: block;
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.2rem;
        }

        #chatCSMessages .sender {
            background-color: #e0f7fa;
            /* Light blue for sender */
            margin-left: auto;
            text-align: right;
        }

        #chatCSMessages .receiver {
            background-color: #fce4ec;
            /* Light pink for receiver (admin) */
            margin-right: auto;
            text-align: left;
        }
    </style>
</head>

<body class="font-sans bg-white text-gray-800">
    <header class="bg-white shadow-md py-1 px-6 flex justify-between items-center fixed w-full top-0 z-50 mb-8">
        <div class="flex items-center space-x-3">
            <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="w-28 sm:w-32">
            <div class="relative hidden md:block">
                <input type="text" placeholder="Cari Barang..."
                    class="header-search pl-10 pr-4 py-2 border border-gray-300 rounded-full w-56 lg:w-64 focus:outline-none focus:border-pink-500">
                <svg class="w-5 h-5 absolute left-2.5 top-2.5 text-gray-500 pointer-events-none" fill="currentColor"
                    viewBox="0 0 20 20">
                    <path
                        d="M8 4a4 4 0 104 4 4 0 00-4-4zM2 8a6 6 0 1110.39 3.94l4.3 4.3-1.42 1.42-4.3-4.3A6 6 0 012 8z" />
                </svg>
            </div>
        </div>
        <nav class="nav-center flex-grow hidden md:flex justify-center items-center gap-6">
        </nav>
        <nav class="flex items-center space-x-4 sm:space-x-6">
            <a href="pembeli_dashboard.html"
                class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Beranda</a>
            <div class="dropdown-kategori relative inline-block hidden md:block">
                <a href="pembeli_kategori.html"
                    class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Kategori</a>
                <div class="dropdown-kategori relative inline-block hidden md:block"></div>
            </div>

            <a href="pembeli_keranjang.html" class="relative p-2 text-gray-700 hover:text-pink-600">
                <svg class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
            </a>
            <a href="pembeli_notifikasi.html" class="relative p-2 text-gray-700 hover:text-pink-600"> <svg
                    class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                    </path>
                </svg>
            </a>
            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="User" class="icon-nav w-6 h-6"
                id="userIcon" style="cursor:pointer;">
            <div id="userDropdown"
                class="hidden absolute right-0 top-[60px] bg-white shadow-lg rounded min-w-[160px] z-[1001]">
                <a href="pembeli_akun.html"
                    class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Akun Saya</a>
                <a href="pembeli_pesanan_saya.html"
                    class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Pesanan</a>
                <a href="#" onclick="openChatCS();return false;"
                    class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Chat dengan
                    CS</a>
                <a href="#" id="tokoSayaLink"
                    class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Toko Saya</a>
                <a href="#" onclick="logoutUser();return false;"
                    class="block px-5 py-3 text-red-600 no-underline text-sm">Logout</a>
            </div>
        </nav>
    </header>
    <main class="mt-16">
        <section id="hero-section"
            class="relative h-[80vh] flex items-center justify-center text-center px-4 hero-section">
            <div class="absolute inset-0 overlay-dark z-0"></div>
            <div class="relative z-10 text-white p-4">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">Travel Anywhere, Shop Everywhere</h1>
                <p class="text-lg md:text-xl max-w-2xl mx-auto">Solusi mudah untuk kamu yang mau belanja dari luar
                    negeri
                    dengan mudah dan aman</p>
            </div>
        </section>

        <section class="titipgo-description-section text-center">
            <h2>
                Apa itu
                <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="logo-in-text">
                Itu?
            </h2>
            <p class="text-base">
                Aplikasi TitipGo membantu kamu menemukan produk luar negeri yang kamu mau, tanpa ribet dan bisa langsung
                diantar oleh Jastiper terpercaya. Gabung dan nikmati pengalaman belanja dari berbagai negara hanya dalam
                satu aplikasi. Platform digital terbaik untuk mendukung bisnis untuk menemukan penemuan baru dari
                barang-barang produk unggulan. Kami siap mengantarkan Anda kemana pun Anda inginkan! TitipGo adalah
                aplikasi revolusioner yang dirancang untuk mengubah cara Anda berbelanja dari luar negeri. Dengan
                TitipGo,
                Anda dapat menemukan dan membeli produk-produk unik dari berbagai negara dengan mudah dan aman. Apakah
                Anda
                mencari fashion terbaru dari Paris, gadget inovatif dari Tokyo, atau kerajinan tangan otentik dari Bali,
                TitipGo memiliki semuanya. Kami menghubungkan Anda dengan jastiper terpercaya yang siap membantu Anda
                mendapatkan barang impian Anda tanpa kerumitan. Dengan TitipGo, belanja internasional jadi lebih mudah,
                terjangkau, dan bertanggung jawab. Kami percaya bahwa setiap orang berhak memiliki akses ke
                produk-produk
                berkualitas dari seluruh dunia, dan kami hadir untuk mewujudkannya. Titip Barang Jadi Mudah, Cari
                Jastiper
                Bawa Oleh-Oleh.
            </p>
        </section>

        <section id="produk-best-seller-section" class="relative py-12 text-center">
            <div class="relative z-10 p-4">
                <h2 class="text-3xl font-bold mb-10" id="produk-section-title">Produk</h2>
                <div id="produk-best-seller"
                    class="grid grid-cols-2 sm:grid-cols-2 lg:grid-cols-4 gap-6 px-4 max-w-6xl mx-auto">
                    <p id="loading-products" class="col-span-full text-gray-500">Memuat produk...</p>
                    <p id="no-products-found" class="col-span-full text-gray-500 hidden">Tidak ada produk ditemukan.
                    </p>
                </div>
                <button id="lihat-semua-produk-button"
                    class="mt-10 bg-white text-blue-800 font-bold px-8 py-3 rounded-lg hover:bg-gray-100 transition-colors shadow-md">
                    Lihat Semua
                </button>
            </div>
        </section>

        <section id="negara-terpopuler-section" class="py-10 text-center">
            <h2 class="text-3xl font-bold text-gray-900 mb-10">Negara</h2>
            <div id="negara-terpopuler"
                class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-6 px-4 max-w-6xl mx-auto">
                <p id="loading-countries" class="col-span-full text-gray-500">Memuat negara...</p>
                <p id="no-countries-found" class="col-span-full text-gray-500 hidden">Tidak ada negara ditemukan.</p>
            </div>
            <button id="lihat-semua-negara-button"
                class="mt-10 bg-gray-900 text-white font-bold px-8 py-3 rounded-lg hover:bg-gray-700 transition-colors shadow-md">
                Lihat Semua
            </button>
        </section>
    </main>

    <footer class="bg-blue-900 py-8 px-6 mt-8">
        <div class="container mx-auto flex flex-wrap justify-between items-start text-white text-sm">
            <div class="w-full sm:w-1/3 mb-6 sm:mb-0">
                <h3 class="font-bold text-white mb-3">INFORMASI</h3>
                <ul>
                    <li class="mb-2"><a href="pembeli_tentang_kami.html" class="hover:text-pink-600">Tentang Kami</a>
                    </li>
                    <li class="mb-2"><a href="pembeli_pertanyaan_umum.html" class="hover:text-pink-600">Pertanyaan
                            Umum</a></li>
                    <li class="mb-2"><a href="pembeli_hubungi_kami.html" class="hover:text-pink-600">Hubungi Kami</a>
                    </li>
                </ul>
            </div>
            <div class="w-full sm:w-1/3 flex justify-center items-center mb-6 sm:mb-0">
                <img src="asset/images/titipgo_logo_remove.png" alt="TitipGo Logo" class="w-32">
            </div>
            <div class="w-full sm:w-1/3 text-right">
                <h3 class="font-bold text-white mb-3">IKUTI SOSIAL MEDIA KAMI</h3>
                <ul>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-instagram mr-2"></i><a
                            href="https://www.instagram.com/restiidr_?igsh=MXkwbXQ5OHgxdnJteQ%3D%3D&utm_source=qr"
                            target="_blank" class="hover:text-pink-600">Instagram</a></li>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-facebook mr-2"></i><a
                            href="https://www.instagram.com/sitiiwhy_?igsh=MTk4aWtnbTBmaWZyZQ==" target="_blank"
                            class="hover:text-pink-600">Facebook</a></li>
                    <li class="mb-2 flex items-center justify-end"><i class="fab fa-youtube mr-2"></i><a
                            href="https://www.instagram.com/okay_5527?igsh=MXVkODNpNTNrZ3kwbg==" target="_blank"
                            class="hover:text-pink-600">Youtube</a></li>
                </ul>
            </div>
        </div>
        <div class="text-center text-white text-xs mt-8 opacity-75"> © 2025 TitipGo. All rights reserved.
        </div>
    </footer>
    <div id="chatCSModal"
        style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100vw;height:100vh;background:rgba(0,0,0,0.18);align-items:center;justify-content:center;">
        <div
            style="background:#fff;border-radius:12px;max-width:400px;width:90vw;padding:0 0 16px 0;box-shadow:0 4px 24px rgba(0,0,0,0.12);margin:auto;">
            <div
                style="display:flex;align-items:center;justify-content:space-between;padding:16px 20px 12px 20px;border-bottom:1px solid #eee;">
                <span style="font-weight:bold;font-size:17px;">Chat dengan CS</span>
                <button onclick="document.getElementById('chatCSModal').style.display='none'"
                    style="background:none;border:none;font-size:22px;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:18px 20px 0 20px;min-height:80px; max-height: 300px; overflow-y: auto;">
                <div id="chatCSMessages" style="font-size:15px;color:#444;min-height:40px;">
                    <p class="receiver"><strong>CS:</strong> Selamat datang! Ada yang bisa kami bantu?</p>
                    <p class="sender"><strong>Anda:</strong> Saya ingin bertanya tentang pesanan saya.</p>
                </div>
            </div>
            <div style="padding:10px 20px 0 20px;">
                <label for="chatCSCategory" class="block text-sm font-medium text-gray-700 mb-1">Kategori:</label>
                <select id="chatCSCategory"
                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-pink-500 focus:border-pink-500 sm:text-sm mb-3">
                    <option value="Pertanyaan Umum">Pertanyaan Umum</option>
                    <option value="Laporan Masalah">Laporan Masalah</option>
                    <option value="Saran & Masukan">Saran & Masukan</option>
                    <option value="Lainnya">Lainnya</option>
                </select>
            </div>
            <div style="display:flex;align-items:center;padding:0 20px 0 20px;gap:8px;">
                <input id="chatCSInput" type="text" placeholder="Tulis pesan..."
                    style="flex:1;padding:8px 12px;border-radius:6px;border:1px solid #ccc;font-size:15px;">
                <button onclick="sendCSMessage()"
                    style="background:#1976d2;color:#fff;border:none;padding:8px 18px;border-radius:6px;font-weight:bold;cursor:pointer;">Kirim</button>
            </div>
        </div>
    </div>
    <script type="module">
        // Import Firebase modules (hanya yang diperlukan)
        import { db, auth, collection, getDocs, query, where, doc, getDoc, onAuthStateChanged, signOut } from "./js/firebase-config.js";

        // Global variable to store all products for filtering
        let allProducts = [];
        let currentCountryFilter = null; // New: To keep track of the active country filter

        const produkSectionTitle = document.getElementById('produk-section-title');
        const lihatSemuaProdukButton = document.getElementById('lihat-semua-produk-button');
        const lihatSemuaNegaraButton = document.getElementById('lihat-semua-negara-button');

        // Global map to store country images fetched from Firestore (still useful for display)
        const firestoreCountryImagesMap = new Map();

        // Helper function to convert string to Title Case
        function toTitleCase(str) {
            if (!str) return '';
            return str.replace(/\w\S*/g, function (txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
            });
        }

        // --- PENGATURAN SLIDER HERO SECTION ---
        const heroImages = [
            'asset/images/beranda.jpeg',
            'asset/images/Bg_beranda2.jpeg'
            // Tambahkan gambar lain jika ada
        ];

        let currentHeroImageIndex = 0;
        const heroSection = document.getElementById('hero-section');

        function changeHeroImage() {
            currentHeroImageIndex = (currentHeroImageIndex + 1) % heroImages.length;
            const nextImageUrl = heroImages[currentHeroImageIndex];
            heroSection.style.backgroundImage = `url('${nextImageUrl}')`;
        }

        // Panggil fungsi untuk mengubah gambar setiap beberapa detik (misalnya 5 detik)
        setInterval(changeHeroImage, 5000); // Aktifkan slider gambar otomatis

        // --- FUNGSI DROPDOWN MENU ---
        const userIcon = document.getElementById('userIcon');
        const userDropdown = document.getElementById('userDropdown');
        const tokoSayaLink = document.getElementById('tokoSayaLink'); // Get the "Toko Saya" link

        // Hide user dropdown by default
        userDropdown.classList.add('hidden');

        userIcon.addEventListener('click', function (event) {
            event.preventDefault(); // Mencegah link default action
            userDropdown.classList.toggle('hidden');
        });

        // Tutup dropdown jika klik di luar area dropdown
        document.addEventListener('click', function (event) {
            if (!userIcon.contains(event.target) && !userDropdown.contains(event.target)) {
                userDropdown.classList.add('hidden');
            }
        });

        // Fungsi Logout
        async function logoutUser() {
            try {
                await signOut(auth); // Perform Firebase logout
                alert("Anda telah logout!"); // Use custom modal for alerts later
                window.location.href = "index.html"; // Redirect to login page after logout
            } catch (error) {
                console.error("Error logging out: ", error);
                alert("Gagal logout. Silakan coba lagi."); // Use custom modal for alerts later
            }
        }

        // --- FUNGSI CHAT DENGAN CS (KEMBALI KE TAMPILAN, FUNGSI DINONAKTIFKAN) ---
        const chatCSModal = document.getElementById('chatCSModal');
        const chatCSMessages = document.getElementById('chatCSMessages');
        const chatCSInput = document.getElementById('chatCSInput');
        const chatCSCategory = document.getElementById('chatCSCategory');

        // Fungsi untuk membuka modal chat CS - Hanya menampilkan modal
        function openChatCS() {
            if (!auth.currentUser) {
                alert("Anda harus login untuk mengakses chat.");
                return;
            }
            chatCSModal.style.display = 'flex';
            // Anda bisa mengisi pesan statis di sini jika ingin ada contoh pesan,
            // atau biarkan kosong seperti di HTML jika hanya untuk tampilan awal.
            chatCSMessages.innerHTML = `
                <p class="receiver"><strong>CS:</strong>Hai ada yang bisa kami bantu?</p>
            `;
            chatCSMessages.scrollTop = chatCSMessages.scrollHeight; // Gulir ke bawah
        }

        // Fungsi untuk mengirim pesan ke CS - Hanya menampilkan alert, tidak mengirim
        function sendCSMessage() {
            const messageText = chatCSInput.value.trim();
            if (messageText === "") {
                alert("Pesan tidak boleh kosong!");
                return;
            }
            alert("Maaf, fitur pengiriman pesan sedang dinonaktifkan.");
            chatCSInput.value = ''; // Kosongkan input setelah alert
        }

        // Event listener untuk tombol Enter di input pesan chat
        chatCSInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendCSMessage();
            }
        });

        // Expose functions to global scope for onclick attributes
        window.logoutUser = logoutUser;
        window.openChatCS = openChatCS;
        window.sendCSMessage = sendCSMessage;

        // --- Firebase Data Fetching and Rendering ---
        const produkBestSellerContainer = document.getElementById('produk-best-seller');
        const negaraTerpopulerContainer = document.getElementById('negara-terpopuler');
        const loadingProductsMessage = document.getElementById('loading-products');
        const noProductsFoundMessage = document.getElementById('no-products-found');
        const loadingCountriesMessage = document.getElementById('loading-countries');
        const noCountriesFoundMessage = document.getElementById('no-countries-found');

        // Function to fetch countries from 'negara' collection
        async function fetchCountries() {
            negaraTerpopulerContainer.innerHTML = '';
            loadingCountriesMessage.classList.remove('hidden');
            noCountriesFoundMessage.classList.add('hidden');
            const countries = [];

            try {
                const countriesCollectionRef = collection(db, "negara");
                const countriesSnapshot = await getDocs(countriesCollectionRef);

                if (countriesSnapshot.empty) {
                    noCountriesFoundMessage.classList.remove('hidden');
                    noCountriesFoundMessage.textContent = "Tidak ada negara ditemukan di koleksi 'negara'.";
                    return []; // Return empty array if no countries
                } else {
                    countriesSnapshot.forEach(doc => {
                        const country = { id: doc.id, ...doc.data() };
                        countries.push(country);
                        // Store image URL in map for quick lookup. Use 'imageUrl' or 'gambar' based on your 'negara' collection
                        const imageUrl = country.imageUrl || country.gambar;
                        if (imageUrl) {
                            firestoreCountryImagesMap.set(country.nama.toLowerCase(), imageUrl);
                        }
                    });

                    // Display up to 5 countries
                    const countriesToDisplay = countries.slice(0, 5);
                    countriesToDisplay.forEach(country => {
                        const countryCard = document.createElement('div');
                        countryCard.className = 'country-card bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden';

                        // Use country.imageUrl or country.gambar, fallback to generic placeholder
                        const countryImage = country.imageUrl || country.gambar || 'asset/images/placeholder_country.jpg';
                        countryCard.innerHTML = `
                            <img src="${countryImage}" alt="${country.nama}" class="w-full h-40 object-cover">
                            <div class="country-name-overlay">
                                ${toTitleCase(country.nama)}
                            </div>
                        `;
                        countryCard.addEventListener('click', () => {
                            // Filter products by this country directly on the dashboard
                            filterProductsByCountry(country.nama);
                        });
                        negaraTerpopulerContainer.appendChild(countryCard);
                    });
                }
            } catch (error) {
                console.error("Error fetching countries:", error);
                noCountriesFoundMessage.classList.remove('hidden');
                noCountriesFoundMessage.textContent = `Error memuat negara: ${error.message}`;
                return []; // Return empty array on error
            } finally {
                loadingCountriesMessage.classList.add('hidden');
            }
            return countries; // Return fetched countries
        }

        async function fetchProducts() {
            produkBestSellerContainer.innerHTML = ''; // Clear existing content
            loadingProductsMessage.classList.remove('hidden');
            noProductsFoundMessage.classList.add('hidden');

            try {
                const productsCollectionRef = collection(db, "produk");
                const productsSnapshot = await getDocs(productsCollectionRef);
                const products = [];

                if (productsSnapshot.empty) {
                    noProductsFoundMessage.classList.remove('hidden');
                    noProductsFoundMessage.textContent = "Tidak ada produk ditemukan.";
                } else {
                    productsSnapshot.forEach(doc => {
                        const product = { id: doc.id, ...doc.data() };
                        products.push(product);
                    });
                    allProducts = products; // Store all products globally

                    // Sort products to display the latest first (assuming `tanggalUpload` exists)
                    // If not, you might need a different sorting logic or remove this line.
                    products.sort((a, b) => (b.tanggalUpload?.toDate() || 0) - (a.tanggalUpload?.toDate() || 0));

                    // Render initial products (e.g., top 8)
                    renderProducts(products.slice(0, 8)); // Display initial subset
                }
            } catch (error) {
                console.error("Error fetching products:", error);
                noProductsFoundMessage.classList.remove('hidden');
                noProductsFoundMessage.textContent = `Error memuat produk: ${error.message}`;
            } finally {
                loadingProductsMessage.classList.add('hidden');
            }
        }

        // New function to render products based on a given array
        function renderProducts(productsToRender) {
            produkBestSellerContainer.innerHTML = ''; // Clear current products
            if (productsToRender.length === 0) {
                noProductsFoundMessage.classList.remove('hidden');
                noProductsFoundMessage.textContent = "Tidak ada produk ditemukan.";
            } else {
                noProductsFoundMessage.classList.add('hidden');
                productsToRender.forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'product-card bg-white rounded-lg shadow-md hover:shadow-lg transition-all duration-300 overflow-hidden';

                    // Use product.imageUrl, fallback to placeholder
                    productCard.innerHTML = `
                        <img src="${product.imageUrl || 'asset/images/placeholder_product.jpg'}" alt="${product.namaBarang}" class="w-full h-40 object-cover">
                        <div class="p-4">
                            <h3 class="font-semibold text-lg mb-1">${product.namaBarang}</h3>
                            <p class="text-gray-600 text-sm">Dari: ${toTitleCase(product.negara || 'Tidak Diketahui')}</p>
                            <p class="text-pink-600 font-bold text-lg mt-2">Rp${product.harga?.toLocaleString('id-ID') || '0'}</p>
                        </div>
                    `;
                    // Add click event listener to each product card
                    productCard.addEventListener('click', () => {
                        window.location.href = `pembeli_produk.html?id=${product.id}`;
                    });
                    produkBestSellerContainer.appendChild(productCard);
                });
            }
        }

        // Helper function to set the button's state (text and data-mode)
        function setLihatSemuaButtonState(mode) {
            if (mode === 'reset') {
                lihatSemuaProdukButton.textContent = "Lihat Semua Produk (Reset Filter)";
                lihatSemuaProdukButton.dataset.mode = 'reset';
            } else { // mode === 'viewAll'
                lihatSemuaProdukButton.textContent = "Lihat Semua";
                lihatSemuaProdukButton.dataset.mode = 'viewAll';
            }
        }

        // New function to filter products by country
        function filterProductsByCountry(countryName) {
            currentCountryFilter = countryName.toLowerCase();
            const filtered = allProducts.filter(product =>
                product.negara && product.negara.toLowerCase() === currentCountryFilter
            );
            renderProducts(filtered);
            produkSectionTitle.textContent = `Produk dari ${toTitleCase(countryName)}`;
            setLihatSemuaButtonState('reset'); // Use the new helper function
        }

        // New function to reset product filter
        function resetProductFilter() {
            currentCountryFilter = null;
            renderProducts(allProducts.slice(0, 8)); // Show initial 8 products again
            produkSectionTitle.textContent = "Produk";
            setLihatSemuaButtonState('viewAll'); // Use the new helper function
            searchInput.value = ''; // Clear search input when resetting filter
        }

        // Single, dynamic event listener for "Lihat Semua Produk" button
        lihatSemuaProdukButton.addEventListener('click', () => {
            const buttonMode = lihatSemuaProdukButton.dataset.mode; // Read the mode from data attribute

            if (buttonMode === 'reset') {
                resetProductFilter();
            } else { // mode === 'viewAll'
                window.location.href = 'pembeli_kategori.html';
            }
        });


        // Search functionality
        const searchInput = document.querySelector('.header-search');
        searchInput.addEventListener('input', (event) => {
            const searchTerm = event.target.value.toLowerCase().trim();
            let productsToSearch = allProducts;

            if (currentCountryFilter) {
                productsToSearch = allProducts.filter(product =>
                    product.negara && product.negara.toLowerCase() === currentCountryFilter
                );
            }

            const filteredAndSearchedProducts = productsToSearch.filter(product =>
                product.namaBarang.toLowerCase().includes(searchTerm) ||
                (product.deskripsi && product.deskripsi.toLowerCase().includes(searchTerm))
            );

            renderProducts(filteredAndSearchedProducts);

            if (searchTerm) {
                let title = `Hasil Pencarian untuk "${searchTerm}"`;
                if (currentCountryFilter) {
                    title += ` di ${toTitleCase(currentCountryFilter)}`;
                }
                produkSectionTitle.textContent = title;
                // If searching, keep the button state based on currentCountryFilter
                if (currentCountryFilter) {
                    setLihatSemuaButtonState('reset');
                } else {
                    setLihatSemuaButtonState('viewAll');
                }
                lihatSemuaProdukButton.classList.remove('hidden');
            } else {
                // If search is cleared, revert to state based on country filter
                if (currentCountryFilter) {
                    produkSectionTitle.textContent = `Produk dari ${toTitleCase(currentCountryFilter)}`;
                    renderProducts(allProducts.filter(product => product.negara && product.negara.toLowerCase() === currentCountryFilter));
                    setLihatSemuaButtonState('reset');
                } else {
                    produkSectionTitle.textContent = "Produk";
                    renderProducts(allProducts.slice(0, 8));
                    setLihatSemuaButtonState('viewAll');
                }
                lihatSemuaProdukButton.classList.remove('hidden');
            }
        });


        // Load initial data
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchCountries(); // Fetch countries first to populate the map
            await fetchProducts();  // Then fetch products
            // Set initial button state after products are loaded
            setLihatSemuaButtonState('viewAll'); // Initial state: no filter, view all
        });

        // Event listener for "Lihat Semua Negara" button
        lihatSemuaNegaraButton.addEventListener('click', () => {
            // This button still navigates to the category page for a broader view of all categories/countries
            window.location.href = 'pembeli_kategori.html';
        });

        // Authentication State Change Listener
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log("User logged in:", user.uid);
                // Check if the user is a Jastiper
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists() && userDocSnap.data().role === 'jastiper') {
                    // If user is a Jastiper, redirect Toko Saya link to jastiper_toko_kita.html
                    tokoSayaLink.href = 'jastiper_toko_kita.html';
                } else {
                    // For regular users (pembeli), set to a placeholder or hide if no store functionality
                    // Or redirect to a page where they can register as a jastiper
                    tokoSayaLink.href = 'jastiper_daftar_toko.html'; // Example: Page to become a jastiper
                }
            } else {
                console.log("No user is logged in.");

                tokoSayaLink.href = 'login_user.html'; // Or hide the link if not applicable
            }
        });

    </script>
</body>

</html>
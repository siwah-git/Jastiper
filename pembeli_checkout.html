<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - TitipGo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tambahkan Midtrans Snap JS. GANTI 'YOUR_MIDTRANS_CLIENT_KEY' dengan Client Key Midtrans Anda. -->
    <!-- Untuk lingkungan produksi, ganti 'app.sandbox.midtrans.com' dengan 'app.midtrans.com' -->
    <script type="text/javascript" src="https://app.sandbox.midtrans.com/snap/snap.js" data-client-key="Mid-client-QhAf34WDf37Fc0Ow"></script>
    <style>
        /* Custom CSS untuk header identik dengan produk-gucci.html */
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f5f7fa;
        }

        .header-search {
            font-size: 1rem;
            height: 36px;
            padding-left: 2.2rem;
            padding-right: 1rem;
            border-radius: 9999px;
            width: 180px;
            font-weight: 600;
        }

        @media (min-width: 1024px) {
            .header-search {
                width: 220px;
            }
        }

        .header-search::placeholder {
            color: #a0aec0;
            opacity: 1;
            font-size: 1rem;
            font-weight: 600;
        }

        .icon-nav,
        nav svg {
            width: 20px !important;
            height: 20px !important;
            min-width: 20px;
            min-height: 20px;
        }

        .icon-nav:hover {
            filter: brightness(0.7);
        }

        .nav-center {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1.5rem;
        }

        .nav-center a,
        .nav-center .dropdown-kategori>a {
            padding: 0;
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .dropdown-kategori .dropdown-content,
        #userDropdown {
            min-width: 160px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.10);
            background: #fff;
            padding: 0;
            margin-top: 4px;
        }

        .dropdown-kategori .dropdown-content a,
        #userDropdown a {
            display: block;
            padding: 10px 18px;
            color: #222;
            text-decoration: none;
            font-size: 15px;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.15s, color 0.15s;
        }

        .dropdown-kategori .dropdown-content a:last-child,
        #userDropdown a:last-child {
            border-bottom: none;
        }

        .dropdown-kategori .dropdown-content a:hover,
        #userDropdown a:hover {
            background: #f5f7fa;
            color: #1976d2;
        }

        .logo-titipgo {
            width: 80px !important;
            min-width: 80px;
            max-width: 90px;
        }

        @media (max-width: 900px) {

            .icon-nav,
            nav svg {
                width: 16px !important;
                height: 16px !important;
            }

            .logo-titipgo {
                width: 60px !important;
            }

            .header-search {
                font-size: 0.9rem;
                height: 28px;
                width: 120px;
            }

            .header-search::placeholder {
                font-size: 0.9rem;
            }

            .nav-center a,
            .nav-center .dropdown-kategori>a {
                font-size: 0.9rem;
            }
        }

        .checkout-main {
            background: #f5f7fa;
            padding: 28px 0 28px 0;
            min-height: 100vh;
        }

        .checkout-section {
            background: #eaf6fa;
            margin: 0 auto 12px auto;
            max-width: 1100px;
            border-radius: 6px;
            box-sizing: border-box;
            padding: 18px 28px;
            border: 1px solid #d6eaf5;
        }

        .checkout-alamat {
            padding: 18px 28px 10px 28px;
            position: relative;
            display: flex;
            flex-direction: column;
            border-radius: 6px;
            margin-bottom: 12px;
            border: 1px solid #d6eaf5;
        }

        .checkout-alamat-judul {
            font-weight: bold;
            font-size: 15px;
            margin-bottom: 4px;
        }

        .checkout-alamat-ubah {
            color: #1976d2;
            font-size: 14px;
            position: absolute;
            right: 28px;
            top: 18px;
            cursor: pointer;
        }

        .checkout-alamat-detail {
            font-size: 14px;
            margin-left: 18px;
            margin-top: 2px;
            color: #222;
        }

        .checkout-produk {
            background: #eaf6fa;
            border-radius: 6px;
            padding: 0 0 12px 0;
            margin-bottom: 12px;
            border: 1px solid #d6eaf5;
        }

        .checkout-produk-header {
            display: flex;
            align-items: center;
            background: #eaf6fa;
            border-bottom: 1px solid #d6eaf5;
            font-weight: bold;
            font-size: 14px;
            padding: 8px 18px 8px 18px;
            border-radius: 6px 6px 0 0;
        }

        .checkout-produk-title {
            flex: 2;
        }

        .checkout-produk-harga {
            flex: 1;
            text-align: right;
        }

        .checkout-produk-jumlah {
            flex: 0.7;
            text-align: center;
        }

        .checkout-produk-total {
            flex: 1;
            text-align: right;
        }

        .checkout-produk-box {
            border: 1px solid #d6eaf5;
            border-radius: 0 0 6px 6px;
            margin: 0 18px 0 18px;
            background: #fff;
            padding-bottom: 8px;
        }

        .checkout-produk-toko {
            font-weight: bold;
            font-size: 13px;
            padding: 8px 0 6px 10px;
            border-bottom: 1px solid #d6eaf5;
        }

        .checkout-produk-item {
            display: flex;
            align-items: center;
            padding: 12px 0 6px 0;
        }

        .checkout-produk-img {
            width: 70px;
            height: 70px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin: 0 14px 0 10px;
        }

        .checkout-produk-info {
            flex: 2;
            min-width: 0;
        }

        .checkout-produk-nama {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 2px;
        }

        .checkout-produk-varian {
            font-size: 13px;
            color: #444;
        }

        .checkout-produk-harga {
            flex: 1;
            text-align: right;
            font-size: 14px;
        }

        .checkout-produk-jumlah {
            flex: 0.7;
            text-align: center;
            font-size: 14px;
        }

        .checkout-produk-total {
            flex: 1;
            text-align: right;
            font-size: 14px;
        }

        .checkout-pesan {
            display: flex;
            align-items: center;
            background: #eaf6fa;
            padding: 10px 28px;
            border-radius: 6px;
            margin-bottom: 12px;
            gap: 14px;
            border: 1px solid #d6eaf5;
        }

        .checkout-pesan-input {
            flex: 1;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #bdbdbd;
            font-size: 14px;
            margin: 0 12px 0 0;
            min-width: 180px;
            max-width: 260px;
        }

        .checkout-pengiriman {
            margin-left: auto;
            font-size: 14px;
        }

        .checkout-pengiriman-estimasi {
            color: #222;
        }

        .checkout-voucher {
            display: flex;
            align-items: center;
            background: #eaf6fa;
            padding: 10px 28px;
            border-radius: 6px;
            margin-bottom: 12px;
            gap: 14px;
            border: 1px solid #d6eaf5;
        }

        .checkout-voucher-link {
            color: #1976d2;
            margin: 0 12px 0 0;
            font-size: 14px;
            text-decoration: underline;
            cursor: pointer;
        }

        .checkout-metode-row {
            display: flex;
            align-items: center;
            margin-left: auto;
            gap: 8px;
        }

        .checkout-metode {
            font-size: 14px;
        }

        .checkout-metode-bank {
            color: #222;
        }

        .checkout-metode-ubah {
            margin-left: 8px;
            font-size: 14px;
        }

        .checkout-rincian {
            background: #eaf6fa;
            border-radius: 6px;
            padding: 18px 28px;
            max-width: 1100px;
            margin: 0 auto 0 auto;
            box-sizing: border-box;
            border: 1px solid #d6eaf5;
        }

        .checkout-rincian-title {
            font-weight: bold;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .checkout-rincian-row {
            display: flex;
            justify-content: space-between;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .checkout-rincian-total {
            font-weight: bold;
            color: #d32f2f;
            margin-top: 8px;
            margin-bottom: 12px;
        }

        .checkout-total-harga {
            color: #d32f2f;
            font-weight: bold;
        }

        .checkout-btn {
            background: #22c100;
            color: #fff;
            border: none;
            border-radius: 18px;
            padding: 7px 24px;
            font-size: 15px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.10);
            cursor: pointer;
            transition: background 0.2s;
            width: 100%;
            margin-top: 6px;
        }

        .checkout-btn:hover {
            background: #1a9e00;
        }

        @media (max-width: 900px) {

            .checkout-main,
            .checkout-section,
            .checkout-rincian {
                padding-left: 2vw !important;
                padding-right: 2vw !important;
            }

            .checkout-section,
            .checkout-produk-box,
            .checkout-rincian {
                max-width: 98vw;
                margin-left: auto;
                margin-right: auto;
            }

            .checkout-rincian {
                margin: 24px auto 0 auto;
                max-width: 98vw;
            }
        }

        /* Modal Alamat */
        .modal-alamat {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }

        .modal-alamat-backdrop {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.4);
            transition: opacity 0.2s;
        }

        .modal-alamat-content {
            position: relative;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border: 1px solid #bfdbfe; /* blue-200 */
            padding: 1rem;
            width: 100%;
            max-width: 24rem; /* max-w-xs */
            margin-left: auto;
            margin-right: auto;
            transition: all 0.2s;
        }

        .modal-alamat-title {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 0.75rem;
            cursor: move;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1d4ed8; /* blue-700 */
        }

        .modal-alamat-input {
            width: 100%;
            padding: 0.5rem 0.75rem;
            border: 1px solid #d1d5db; /* gray-300 */
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.875rem; /* text-sm */
            margin-bottom: 0.75rem;
        }

        .modal-alamat-btn-row {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .modal-alamat-btn-pilih {
            background-color: #2563eb; /* blue-600 */
            color: white;
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .modal-alamat-btn-pilih:hover {
            background-color: #1e40af; /* blue-700 */
        }

        .modal-alamat-btn-batal {
            background-color: #e5e7eb; /* gray-200 */
            color: #374151; /* gray-800 */
            padding: 0.375rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .modal-alamat-btn-batal:hover {
            background-color: #d1d5db; /* gray-300 */
        }
    </style>
</head>

<body class="font-sans bg-gray-100 m-0">
    <header class="bg-white shadow-md py-1 px-6 flex justify-between items-center fixed w-full top-0 z-50 mb-8">
        <div class="flex items-center space-x-3">
            <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="w-28 sm:w-32">
            <div class="relative hidden md:block">
                <input type="text" placeholder="Cari Barang..."
                    class="header-search pl-10 pr-4 py-2 border border-gray-300 rounded-full w-56 lg:w-64 focus:outline-none focus:border-pink-500">
                <svg class="w-5 h-5 absolute left-2.5 top-2.5 text-gray-500 pointer-events-none" fill="currentColor"
                    viewBox="0 0 20 20">
                    <path
                        d="M8 4a4 4 0 104 4 4 4 0 00-4-4zM2 8a6 6 0 1110.39 3.94l4.3 4.3-1.42 1.42-4.3-4.3A6 6 0 012 8z" />
                </svg>
            </div>
        </div>
        <nav class="nav-center flex-grow hidden md:flex justify-center items-center gap-6">
        </nav>
        <nav class="flex items-center space-x-4 sm:space-x-6">
            <a href="pembeli_dashboard.html"
                class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Beranda</a>
            <div class="dropdown-kategori relative inline-block hidden md:block">
                <a href="pembeli_kategori.html"
                    class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Kategori</a>
                <div class="dropdown-kategori relative inline-block hidden md:block"></div>
            </div>

            <a href="pembeli_keranjang.html" class="relative p-2 text-gray-700 hover:text-pink-600">
                <svg class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
                    </path>
                </svg>
            </a>
            <a href="pembeli_notifikasi.html" class="relative p-2 text-gray-700 hover:text-pink-600"> <svg
                    class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
                    </path>
                </svg>
            </a>
            <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="User" class="icon-nav w-6 h-6"
                id="userIcon" style="cursor:pointer;">
            <div id="userDropdown"
                class="hidden absolute right-0 top-[60px] bg-white shadow-lg rounded min-w-[160px] z-[1001]">
                <a href="pembeli_akun.html"
                    class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Akun Saya</a>
                <a href="pembeli_pesanan_saya.html"
                    class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Pesanan</a>
                <a href="#" onclick="openChatCS();return false;"
                    class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Chat dengan
                    CS</a>
                <a href="#" onclick="openTokoSaya();return false;"
                    class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Toko Saya</a>
                <a href="#" onclick="logoutUser();return false;"
                    class="block px-5 py-3 text-red-600 no-underline text-sm">Logout</a>
            </div>
        </nav>
    </header>
    <main class="pt-32">
        <h1 class="page-title"
            style="text-align:center;font-size:2rem;font-weight:bold;margin:32px 0 16px 0;letter-spacing:1px;">CHECKOUT
        </h1>
        <div class="checkout-main">
            <div class="checkout-section checkout-alamat">
                <div class="flex items-center justify-between">
                    <span class="checkout-alamat-judul">&#9679; Alamat Pengantaran</span>
                    <button type="button"
                        class="px-3 py-1 rounded bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 transition"
                        onclick="openAlamatModal()">Ubah</button>
                </div>
                <div class="checkout-alamat-detail">
                    <div id="namaPenerima">Resty (08673732739729)</div>
                    <div id="alamatLengkap">Jl.Menuju Kesuksesan No.15 Perumahan Maritza, Teras, Boyolali (C10)</div>
                </div>
            </div>
            <div class="checkout-section checkout-produk">
                <div class="checkout-produk-header">
                    <span class="checkout-produk-title">Produk Dipesan</span>
                    <span class="checkout-produk-harga">Harga Satuan</span>
                    <span class="checkout-produk-jumlah">Jumlah</span>
                    <span class="checkout-produk-total">Total Harga</span>
                </div>
                <div class="checkout-produk-box" id="checkoutProdukBox">
                </div>
            </div>
            <div class="checkout-section checkout-pesan">
                <span>Pesan</span>
                <input type="text" class="checkout-pesan-input" id="pesanInput" placeholder="Tulis pesan untuk penjual...">
                <span class="checkout-pengiriman">Pengiriman: <span class="checkout-pengiriman-estimasi">Estimasi Tiba 20-23
                        Agustus 2025</span></span>
            </div>
            <div class="checkout-section checkout-voucher">
                <span class="checkout-metode">Metode Pembayaran: <span class="checkout-metode-bank" id="metodeBank">Transfer
                        Bank (BCA)</span></span>
                <button type="button" id="ubahPembayaran"
                    class="ml-2 px-3 py-1 rounded bg-blue-600 text-white text-xs font-semibold hover:bg-blue-700 transition">Ubah</button>
                </span>
            </div>
            <div class="checkout-section checkout-rincian">
                <div class="checkout-rincian-title">Rincian Harga</div>
                <div class="checkout-rincian-row"><span>Subtotal Pesanan</span><span id="subtotalPesanan">Rp. 0</span></div>
                <div class="checkout-rincian-row"><span>Subtotal Pengiriman</span><span id="subtotalPengiriman">Rp.
                        100.000</span></div>
                <div class="checkout-rincian-row"><span>Biaya Layanan</span><span id="biayaLayanan">Rp. 100.000</span></div>
                <div class="checkout-rincian-row"><span>Fee Jastiper</span><span id="feeJastiper">Rp. 100.000</span></div>
                <div class="checkout-rincian-row checkout-rincian-total"><span>Total Harga</span><span
                        class="checkout-total-harga" id="totalHarga">Rp. 0</span></div>
                <button class="checkout-btn" id="checkoutButton" disabled>Memuat...</button>
            </div>
        </div>

        <div class="modal-bank fixed inset-0 flex items-center justify-center z-[1002]" id="modalBank"
            style="display:none;">
            <div class="modal-bank-backdrop absolute inset-0 bg-black opacity-40 transition-opacity duration-200"></div>
            <div
                class="modal-bank-content relative bg-white rounded-xl shadow-2xl border border-blue-200 p-4 w-full max-w-xs mx-auto transition-all duration-200"
                style="min-width:240px;">
                <div
                    class="modal-bank-title font-bold text-base mb-3 cursor-move select-none flex items-center gap-2 text-blue-700">
                    Pilih Metode Pembayaran
                </div>
                <form id="formBank" class="flex flex-col gap-2">
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (BCA)" class="accent-blue-600" checked>
                        <img src="asset/bca.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="BCA">
                        <span class="text-sm">Bank BCA</span>
                    </label>
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (Mandiri)" class="accent-blue-600">
                        <img src="asset/mandiri.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="Mandiri">
                        <span class="text-sm">Bank Mandiri</span>
                    </label>
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (BNI)" class="accent-blue-600">
                        <img src="asset/bni.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="BNI">
                        <span class="text-sm">Bank BNI</span>
                    </label>
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (BRI)" class="accent-blue-600">
                        <img src="asset/bri.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="BRI">
                        <span class="text-sm">Bank BRI</span>
                    </label>
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (CIMB Niaga)" class="accent-blue-600">
                        <img src="asset/cimb.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="CIMB Niaga">
                        <span class="text-sm">Bank CIMB Niaga</span>
                    </label>
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (Permata)" class="accent-blue-600">
                        <img src="asset/permata.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="Permata">
                        <span class="text-sm">Bank Permata</span>
                    </label>
                    <label class="modal-bank-row flex items-center gap-2 p-2 rounded hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="bank" value="Transfer Bank (Syariah Indonesia)" class="accent-blue-600">
                        <img src="asset/bsi.jfif" class="modal-bank-logo w-8 h-5 object-contain" alt="BSI">
                        <span class="text-sm">Bank Syariah Indonesia (BSI)</span>
                    </label>
                </form>
                <div class="modal-bank-btn-row flex justify-end gap-2 mt-4">
                    <button id="modalBankPilih" type="button" onclick="pilihBank()"
                        class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 transition">Pilih</button>
                    <button id="modalBankBatal" type="button" onclick="batalBank()"
                        class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded text-sm hover:bg-gray-300 transition">Batal</button>
                </div>
            </div>
        </div>

        <div class="modal-alamat fixed inset-0 flex items-center justify-center z-[1002]" id="modalAlamat"
            style="display:none;">
            <div class="modal-alamat-backdrop absolute inset-0 bg-black opacity-40 transition-opacity duration-200"></div>
            <div
                class="modal-alamat-content relative bg-white rounded-xl shadow-2xl border border-blue-200 p-4 w-full max-w-xs mx-auto transition-all duration-200">
                <div
                    class="modal-alamat-title font-bold text-base mb-3 cursor-move select-none flex items-center gap-2 text-blue-700">
                    Ubah Alamat Pengantaran
                </div>
                <form id="formAlamat" class="flex flex-col gap-2">
                    <label for="inputNamaPenerima" class="text-sm text-gray-700">Nama Penerima:</label>
                    <input type="text" id="inputNamaPenerima" class="modal-alamat-input" placeholder="Nama Penerima">

                    <label for="inputTeleponPenerima" class="text-sm text-gray-700">Nomor Telepon:</label>
                    <input type="tel" id="inputTeleponPenerima" class="modal-alamat-input" placeholder="Nomor Telepon">

                    <label for="inputAlamatLengkap" class="text-sm text-gray-700">Alamat Lengkap:</label>
                    <textarea id="inputAlamatLengkap" class="modal-alamat-input h-24 resize-none"
                        placeholder="Alamat Lengkap"></textarea>
                </form>
                <div class="modal-alamat-btn-row flex justify-end gap-2 mt-4">
                    <button id="modalAlamatSimpan" type="button" onclick="simpanAlamat()"
                        class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm hover:bg-blue-700 transition">Simpan</button>
                    <button id="modalAlamatBatal" type="button" onclick="batalAlamat()"
                        class="bg-gray-200 text-gray-800 px-3 py-1.5 rounded text-sm hover:bg-gray-300 transition">Batal</button>
                </div>
            </div>
        </div>

        <script>
            let checkoutData = {
                products: [],
                subtotal: 0,
                shipping: 100000,
                service: 100000,
                jastiper: 100000,
                total: 0
            };

            // Helper function to format currency
            function formatRupiah(amount) {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0
                }).format(amount);
            }

            function loadCheckoutData() {
                // Load from cart or direct product
                const cartData = localStorage.getItem('checkoutCart');
                const productData = localStorage.getItem('checkoutProduct');

                if (cartData) {
                    checkoutData.products = JSON.parse(cartData);
                } else if (productData) {
                    checkoutData.products = [JSON.parse(productData)];
                } else {
                    // Default data if nothing in localStorage
                    checkoutData.products = [{
                        name: 'Baju Gucci G6000 Man Limited Edition',
                        color: 'Hitam',
                        size: 'M',
                        quantity: 2,
                        price: 3000000,
                        store: 'Rifal Store'
                    }];
                }

                calculateTotals();
                displayProducts();
            }

            function displayProducts() {
                const container = document.getElementById('checkoutProdukBox');

                // Group products by store
                const stores = {};
                checkoutData.products.forEach(product => {
                    if (!stores[product.store]) {
                        stores[product.store] = [];
                    }
                    stores[product.store].push(product);
                });

                container.innerHTML = Object.keys(stores).map(storeName => {
                    const storeProducts = stores[storeName];

                    return `
                        <div class="checkout-produk-toko">${storeName}</div>
                        ${storeProducts.map(product => `
                            <div class="checkout-produk-item">
                                <img src="asset/images/ootd (1).jpg" alt="${product.name}" class="checkout-produk-img" style="width:60px;height:60px;object-fit:cover;border-radius:6px;">
                                <div class="checkout-produk-info">
                                    <div class="checkout-produk-nama">${product.name}</div>
                                    <div class="checkout-produk-varian">${product.color}, ${product.size}</div>
                                </div>
                                <div class="checkout-produk-harga">${formatRupiah(product.price)}</div>
                                <div class="checkout-produk-jumlah">${product.quantity}</div>
                                <div class="checkout-produk-total">${formatRupiah(product.price * product.quantity)}</div>
                            </div>
                        `).join('')}
                    `;
                }).join('');
            }

            function calculateTotals() {
                checkoutData.subtotal = checkoutData.products.reduce((sum, product) => {
                    return sum + (product.price * product.quantity);
                }, 0);

                checkoutData.total = checkoutData.subtotal + checkoutData.shipping + checkoutData.service + checkoutData.jastiper;

                // Update display using formatRupiah
                document.getElementById('subtotalPesanan').textContent = formatRupiah(checkoutData.subtotal);
                document.getElementById('subtotalPengiriman').textContent = formatRupiah(checkoutData.shipping);
                document.getElementById('biayaLayanan').textContent = formatRupiah(checkoutData.service);
                document.getElementById('feeJastiper').textContent = formatRupiah(checkoutData.jastiper);
                document.getElementById('totalHarga').textContent = formatRupiah(checkoutData.total);
            }

            // Modal Alamat
            const modalAlamat = document.getElementById('modalAlamat');
            const inputNamaPenerima = document.getElementById('inputNamaPenerima');
            const inputTeleponPenerima = document.getElementById('inputTeleponPenerima');
            const inputAlamatLengkap = document.getElementById('inputAlamatLengkap');
            const alamatModalContent = document.querySelector('#modalAlamat .modal-alamat-content');

            function openAlamatModal() {
                // Populate current address details into the modal inputs
                const currentNamaPenerima = document.getElementById('namaPenerima').textContent;
                const currentAlamatLengkap = document.getElementById('alamatLengkap').textContent;

                const nameMatch = currentNamaPenerima.match(/(.*)\s\((\d+)\)/);
                if (nameMatch) {
                    inputNamaPenerima.value = nameMatch[1];
                    inputTeleponPenerima.value = nameMatch[2];
                } else {
                    inputNamaPenerima.value = currentNamaPenerima; // Fallback if format is different
                    inputTeleponPenerima.value = '';
                }
                inputAlamatLengkap.value = currentAlamatLengkap;

                modalAlamat.style.display = 'flex';
                // Reset posisi modal ke tengah
                alamatModalContent.style.position = 'absolute';
                alamatModalContent.style.left = '50%';
                alamatModalContent.style.top = '50%';
                alamatModalContent.style.transform = 'translate(-50%, -50%)';
                alamatModalContent.style.right = 'auto';
            }

            function simpanAlamat() {
                const nama = inputNamaPenerima.value.trim();
                const telepon = inputTeleponPenerima.value.trim();
                const alamat = inputAlamatLengkap.value.trim();

                if (nama && telepon && alamat) {
                    document.getElementById('namaPenerima').textContent = `${nama} (${telepon})`;
                    document.getElementById('alamatLengkap').textContent = alamat;
                    modalAlamat.style.display = 'none';
                } else {
                    alert('Mohon lengkapi semua kolom alamat.');
                }
            }

            function batalAlamat() {
                modalAlamat.style.display = 'none';
                // Reset posisi modal ke tengah
                alamatModalContent.style.left = '50%';
                alamatModalContent.style.top = '50%';
                alamatModalContent.style.transform = 'translate(-50%, -50%)';
                alamatModalContent.style.right = 'auto';
            }

            modalAlamat.querySelector('.modal-alamat-backdrop').onclick = function () {
                modalAlamat.style.display = 'none';
                // Reset posisi modal ke tengah
                alamatModalContent.style.left = '50%';
                alamatModalContent.style.top = '50%';
                alamatModalContent.style.transform = 'translate(-50%, -50%)';
                alamatModalContent.style.right = 'auto';
            };

            // Drag modal Alamat
            let isDraggingAlamat = false, startXAlamat, startYAlamat, startLeftAlamat, startTopAlamat;
            const titleBarAlamat = document.querySelector('.modal-alamat-title');
            titleBarAlamat.style.cursor = 'move';
            titleBarAlamat.addEventListener('mousedown', function (e) {
                isDraggingAlamat = true;
                startXAlamat = e.clientX;
                startYAlamat = e.clientY;
                const rect = alamatModalContent.getBoundingClientRect();
                startLeftAlamat = rect.left;
                startTopAlamat = rect.top;
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function (e) {
                if (!isDraggingAlamat) return;
                let dx = e.clientX - startXAlamat;
                let dy = e.clientY - startYAlamat;
                alamatModalContent.style.left = (startLeftAlamat + dx) + 'px';
                alamatModalContent.style.top = (startTopAlamat + dy) + 'px';
                alamatModalContent.style.right = 'auto';
                alamatModalContent.style.transform = 'none';
            });

            document.addEventListener('mouseup', function () {
                isDraggingAlamat = false;
                document.body.style.userSelect = '';
            });

            // Modal pembayaran
            const modalBank = document.getElementById('modalBank');
            const ubahPembayaran = document.getElementById('ubahPembayaran');
            const metodeBank = document.getElementById('metodeBank');
            const formBank = document.getElementById('formBank');
            const modalContent = document.querySelector('.modal-bank-content');

            ubahPembayaran.onclick = function (e) {
                e.preventDefault();
                modalBank.style.display = 'flex';
                // Reset posisi modal ke tengah
                modalContent.style.position = 'absolute';
                modalContent.style.left = '50%';
                modalContent.style.top = '50%';
                modalContent.style.transform = 'translate(-50%, -50%)';
                modalContent.style.right = 'auto';
            };

            function batalBank() {
                modalBank.style.display = 'none';
                // Reset posisi modal ke tengah
                modalContent.style.left = '50%';
                modalContent.style.top = '50%';
                modalContent.style.transform = 'translate(-50%, -50%)';
                modalContent.style.right = 'auto';
            }

            function pilihBank() {
                const val = formBank.bank.value;
                metodeBank.textContent = val;
                modalBank.style.display = 'none';
                // Reset posisi modal ke tengah
                modalContent.style.left = '50%';
                modalContent.style.top = '50%';
                modalContent.style.transform = 'translate(-50%, -50%)';
                modalContent.style.right = 'auto';
            }

            modalBank.querySelector('.modal-bank-backdrop').onclick = function () {
                modalBank.style.display = 'none';
                // Reset posisi modal ke tengah
                modalContent.style.left = '50%';
                modalContent.style.top = '50%';
                modalContent.style.transform = 'translate(-50%, -50%)';
                modalContent.style.right = 'auto';
            };

            // Drag modal Bank
            let isDraggingBank = false, startXBank, startYBank, startLeftBank, startTopBank;
            const titleBarBank = document.querySelector('.modal-bank-title');
            titleBarBank.style.cursor = 'move';
            titleBarBank.addEventListener('mousedown', function (e) {
                isDraggingBank = true;
                startXBank = e.clientX;
                startYBank = e.clientY;
                const rect = modalContent.getBoundingClientRect();
                startLeftBank = rect.left;
                startTopBank = rect.top;
                document.body.style.userSelect = 'none';
            });

            document.addEventListener('mousemove', function (e) {
                if (!isDraggingBank) return;
                let dx = e.clientX - startXBank;
                let dy = e.clientY - startYBank;
                modalContent.style.left = (startLeftBank + dx) + 'px';
                modalContent.style.top = (startTopBank + dy) + 'px';
                modalContent.style.right = 'auto';
                modalContent.style.transform = 'none';
            });

            document.addEventListener('mouseup', function () {
                isDraggingBank = false;
                document.body.style.userSelect = '';
            });

            // Load data when page loads
            window.onload = function () {
                loadCheckoutData();
                // Event listener for user dropdown
                const userIcon = document.getElementById('userIcon');
                const userDropdown = document.getElementById('userDropdown');

                if (userIcon && userDropdown) {
                    userIcon.addEventListener('click', function () {
                        userDropdown.classList.toggle('hidden');
                    });

                    // Close dropdown if clicked outside
                    document.addEventListener('click', function (event) {
                        if (!userIcon.contains(event.target) && !userDropdown.contains(event.target)) {
                            userDropdown.classList.add('hidden');
                        }
                    });
                }

                // Event listener for kategori dropdown
                const kategoriMenu = document.getElementById('kategoriMenu');
                const dropdownKategori = document.getElementById('dropdownKategori');

                if (kategoriMenu && dropdownKategori) {
                    kategoriMenu.addEventListener('click', function (event) {
                        event.preventDefault(); // Prevent default anchor behavior
                        dropdownKategori.style.display = dropdownKategori.style.display === 'block' ? 'none' : 'block';
                    });

                    // Close dropdown if clicked outside
                    document.addEventListener('click', function (event) {
                        if (!kategoriMenu.contains(event.target) && !dropdownKategori.contains(event.target)) {
                            dropdownKategori.style.display = 'none';
                        }
                    });
                }

                // Add event listener for the checkout button
                document.getElementById('checkoutButton').onclick = prosesCheckout;
            };


            // --- Dropdown User Icon Akun ---
            function logoutUser() {
                alert('Berhasil logout!');
                const userDropdown = document.getElementById('userDropdown'); // Ensure userDropdown is defined
                if (userDropdown) userDropdown.classList.add('hidden');
                // You might want to add Firebase logout here
                // auth.signOut().then(() => {
                //   console.log("User signed out");
                //   localStorage.removeItem('userId'); // Clear userId on logout
                //   window.location.href = 'login.html'; // Redirect to login page
                // }).catch((error) => {
                //   console.error("Error signing out: ", error);
                // });
            }
            function openChatCS() {
                alert('Fitur chat CS akan segera hadir!');
                const userDropdown = document.getElementById('userDropdown'); // Ensure userDropdown is defined
                if (userDropdown) userDropdown.classList.add('hidden');
            }

            function openTokoSaya() {
                alert('Fitur Toko Saya akan segera hadir!'); // Placeholder for Toko Saya
                const userDropdown = document.getElementById('userDropdown');
                if (userDropdown) userDropdown.classList.add('hidden');
            }
        </script>
          <script type="module">
    import { db, auth } from './js/firebase-config.js';
    import { collection, getDocs, addDoc, Timestamp } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore.js';
    import { getFunctions, httpsCallable } from 'https://www.gstatic.com/firebasejs/9.6.0/firebase-functions.js';

    // Import the 'functions' object directly for functions.config()
    // import * as functions from 'firebase-functions'; // BARIS INI DITAMBAHKAN - Ini tidak diperlukan di sisi client

    let isFirebaseReady = false; // Flag untuk melacak apakah Firebase Auth sudah siap

    // Fungsi untuk memanggil Firebase Function
    const callCreateMidtransTransaction = httpsCallable(getFunctions(), 'createMidtransTransaction');

    // Listener untuk perubahan status otentikasi Firebase
    auth.onAuthStateChanged(user => {
        if (user) {
            console.log("Pengguna terotentikasi:", user.uid);
            localStorage.setItem('userId', user.uid); // Pastikan userId tersimpan di localStorage
        } else {
            console.log("Pengguna tidak terotentikasi.");
            localStorage.removeItem('userId'); // Hapus userId jika tidak terotentikasi
        }
        isFirebaseReady = true; // Set flag menjadi true setelah status otentikasi diketahui
        // Aktifkan tombol checkout jika Firebase sudah siap
        const checkoutButton = document.getElementById('checkoutButton');
        if (checkoutButton) {
            checkoutButton.disabled = false;
            checkoutButton.textContent = 'Checkout';
        }
    });

    async function debugFirestore() {
      const collections = ['users', 'products', 'orders', 'ratings', 'chats'];
      for (const col of collections) {
        try {
          const snap = await getDocs(collection(db, col));
          console.log(`Data koleksi ${col}:`);
          snap.forEach(doc => console.log(doc.id, doc.data()));
        } catch (e) {
          console.error(`Gagal ambil data koleksi ${col}:`, e);
        }
      }
    }
    debugFirestore();

    window.prosesCheckout = async function() {
      // Pastikan Firebase Auth sudah siap sebelum melanjutkan
      if (!isFirebaseReady) {
          alert('Sistem sedang memuat. Mohon tunggu sebentar.');
          return;
      }

      // Ambil data user login dari Firebase Auth
      const userId = auth.currentUser ? auth.currentUser.uid : null;
      if (!userId) {
        alert('Anda harus login untuk melanjutkan checkout.');
        window.location.href = 'login.html'; // Redirect ke halaman login
        return;
      }

      // Dapatkan email pengguna dari Firebase Auth (jika tersedia)
      let userEmail = auth.currentUser ? auth.currentUser.email : '';

      // Ambil produk dari localStorage
      const products = JSON.parse(localStorage.getItem('checkoutCart') || localStorage.getItem('checkoutProduct') || '[]');
      if (products.length === 0) {
        alert('Keranjang belanja kosong atau tidak ada produk untuk checkout.');
        return;
      }

      // Ambil alamat dan metode bayar
      const namaPenerimaText = document.getElementById('namaPenerima').textContent;
      const namaPenerimaMatch = namaPenerimaText.match(/(.*)\s\((\d+)\)/);
      const namaPenerima = namaPenerimaMatch ? namaPenerimaMatch[1] : namaPenerimaText;
      const teleponPenerima = namaPenerimaMatch ? namaPenerimaMatch[2] : '';
      const alamatLengkap = document.getElementById('alamatLengkap').textContent;
      const metodeBayar = document.querySelector('input[name=bank]:checked')?.value || 'Transfer Bank (BCA)';
      
      // Hitung total dari checkoutData global
      const total = checkoutData.total;

      try {
        // Nonaktifkan tombol checkout sementara proses berlangsung
        const checkoutButton = document.getElementById('checkoutButton');
        if (checkoutButton) {
            checkoutButton.disabled = true;
            checkoutButton.textContent = 'Memproses...';
        }

        // Panggil Firebase Function untuk membuat transaksi Midtrans
        const result = await callCreateMidtransTransaction({
          products: checkoutData.products, // Kirim produk yang sudah terformat dari checkoutData
          total: checkoutData.total, // Kirim total yang sudah dihitung
          namaPenerima: namaPenerima,
          teleponPenerima: teleponPenerima,
          alamatLengkap: alamatLengkap,
          emailPengguna: userEmail // Kirim email pengguna
        });

        const snapToken = result.data.snapToken;
        const orderId = result.data.orderId;

        // Simpan orderId ke Firestore lokal sebelum membuka Snap
        await addDoc(collection(db, "orders"), {
            userId: userId,
            products: checkoutData.products,
            total: checkoutData.total,
            status: "pending", // Set status awal pending
            alamat: alamatLengkap,
            nama_penerima: namaPenerima,
            telepon_penerima: teleponPenerima,
            metodeBayar: metodeBayar,
            orderIdMidtrans: orderId, // Simpan order ID dari Midtrans
            createdAt: Timestamp.now()
        });

        // Tampilkan pop-up pembayaran Midtrans Snap
        window.snap.pay(snapToken, {
          onSuccess: function(result){
            /* You may add your own implementation here */
            alert("Pembayaran berhasil! Order ID: " + result.order_id);
            // Update status order di Firestore menjadi "success" atau "settlement"
            // Ini memerlukan fungsi update di Firebase Functions atau di client jika aturan keamanannya memungkinkan
            console.log("Pembayaran berhasil:", result);
            window.location.href = "pembeli_pembayaran.html?order_id=" + orderId; // Redirect ke halaman pembayaran dengan orderId
          },
          onPending: function(result){
            /* You may add your own implementation here */
            alert("Menunggu pembayaran Anda. Order ID: " + result.order_id);
            // Update status order di Firestore menjadi "pending"
            console.log("Pembayaran pending:", result);
            window.location.href = "pembeli_pembayaran.html?order_id=" + orderId; // Redirect ke halaman pembayaran dengan orderId
          },
          onError: function(result){
            /* You may add your own implementation here */
            alert("Pembayaran gagal! Order ID: " + result.order_id);
            // Update status order di Firestore menjadi "failed" atau "cancel"
            console.log("Pembayaran error:", result);
            window.location.href = "pembeli_pesanan_saya.html"; // Redirect ke halaman pesanan saya
          },
          onClose: function(){
            /* You may add your own implementation here */
            alert('Anda menutup jendela pembayaran.');
            console.log("Jendela pembayaran ditutup.");
            window.location.href = "pembeli_pesanan_saya.html"; // Kembali ke halaman pesanan saya
          }
        });

      } catch (error) {
        console.error("Error saat proses checkout:", error);
        alert("Terjadi kesalahan saat membuat pesanan. Silakan coba lagi. " + error.message);
      } finally {
          // Selalu aktifkan kembali tombol checkout setelah proses selesai (berhasil atau gagal)
          const checkoutButton = document.getElementById('checkoutButton');
          if (checkoutButton) {
              checkoutButton.disabled = false;
              checkoutButton.textContent = 'Checkout';
          }
      }
    }
  </script>


        <footer class="bg-blue-900 py-8 px-6 mt-8">
            <div class="container mx-auto flex flex-wrap justify-between items-start text-white text-sm">
                <div class="w-full sm:w-1/3 mb-6 sm:mb-0">
                    <h3 class="font-bold text-white mb-3">INFORMASI</h3>
                    <ul>
                        <li class="mb-2"><a href="pembeli_tentang_kami.html" class="hover:text-pink-600">Tentang Kami</a></li>
                        <li class="mb-2"><a href="pembeli_pertanyaan_umum.html" class="hover:text-pink-600">Pertanyaan Umum</a></li>
                        <li class="mb-2"><a href="pembeli_hubungi_kami.html" class="hover:text-pink-600">Hubungi Kami</a></li>
                    </ul>
                </div>
                <div class="w-full sm:w-1/3 flex justify-center items-center mb-6 sm:mb-0">
                    <img src="asset/images/titipgo_logo_remove.png" alt="TitipGo Logo" class="w-32">
                </div>
                <div class="w-full sm:w-1/3 text-right">
                    <h3 class="font-bold text-white mb-3">IKUTI SOSIAL MEDIA KAMI</h3>
                    <ul>
                        <li class="mb-2 flex items-center justify-end"><i class="fab fa-instagram mr-2"></i><a
                                href="https://www.instagram.com/restiidr_?igsh=MXkwbXQ5OHgxdnJteQ%3D%3D&utm_source=qr"
                                target="_blank" class="hover:text-pink-600">Instagram</a></li>
                        <li class="mb-2 flex items-center justify-end"><i class="fab fa-facebook mr-2"></i><a
                                href="https://www.instagram.com/sitiiwhy_?igsh=MTk4aWtnbTBmaWZyZQ==" target="_blank"
                                class="hover:text-pink-600">Facebook</a></li>
                        <li class="mb-2 flex items-center justify-end"><i class="fab fa-youtube mr-2"></i><a
                                href="https://www.instagram.com/okay_5527?igsh=MXVkODNpNTNrZ3kwbg==" target="_blank"
                                class="hover:text-pink-600">Youtube</a></li>
                    </ul>
                </div>
            </div>
            <div class="text-center text-white text-xs mt-8 opacity-75"> © 2025 TitipGo. All rights reserved.
            </div>
        </footer>
</body>

</html>

<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pesanan Saya - TitipGo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
    }

    .akun-main {
      display: flex;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 0 0 0;
      gap: 32px;
    }

    .akun-sidebar {
      width: 260px;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      padding: 24px 18px 18px 18px;
      min-height: 400px;
      margin-top: 0;
    }

    .akun-user-info {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 18px;
    }

    .akun-user-icon {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #f5f7fa;
      object-fit: cover;
    }

    .akun-username {
      font-weight: bold;
      font-size: 16px;
      color: #222;
    }

    .akun-edit-link {
      color: #1976d2;
      font-size: 13px;
      text-decoration: underline;
      margin-top: 2px;
      display: inline-block;
    }

    .akun-menu {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .akun-menu-item {
      padding: 10px 16px;
      border-radius: 6px;
      color: #333;
      font-size: 15px;
      text-decoration: none;
      transition: background 0.15s, color 0.15s;
    }

    .akun-menu-item.active,
    .akun-menu-item:hover {
      background: #eaf6fa;
      color: #1976d2;
    }

    .akun-content {
      flex: 1;
      min-width: 0;
    }

    .pesanan-content {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
      padding: 32px 28px 28px 28px;
      min-height: 400px;
      flex: 1;
    }

    .pesanan-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 18px;
      flex-wrap: wrap;
    }

    .pesanan-tab {
      padding: 8px 18px;
      border-radius: 12px 12px 0 0;
      background: #f1f5fb;
      color: #ec4899;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      border: 1px solid #f9a8d4;
      border-bottom: none;
      outline: none;
      transition: background 0.15s, color 0.15s;
      text-decoration: none;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.03);
    }

    .pesanan-tab.active,
    .pesanan-tab:focus {
      background: #ec4899;
      color: #fff;
      font-weight: bold;
      box-shadow: 0 2px 8px rgba(236, 72, 153, 0.10);
      border-color: #ec4899;
    }

    .pesanan-tab:not(.active):hover {
      background: #fdf2f8;
      color: #be185d;
    }

    .pesanan-section-title {
      font-size: 18px;
      font-weight: bold;
      margin-bottom: 18px;
      color: #222;
    }

    .pesanan-card {
      background: #f8f9fa;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.04);
      margin-bottom: 18px;
      padding: 18px 18px 12px 18px;
      border: 1px solid #e0e0e0;
    }

    .pesanan-store-info {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .pesanan-store-name {
      font-weight: bold;
      font-size: 15px;
      color: #1976d2;
    }

    .pesanan-store-btn {
      background: #fff;
      color: #d2196f;
      border: 1px solid #1976d2;
      border-radius: 4px;
      padding: 4px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .pesanan-store-btn:hover {
      background: #e3f0ff;
    }

    .pesanan-product {
      display: flex;
      align-items: center;
      gap: 18px;
      margin-bottom: 8px;
    }

    .pesanan-product-image {
      width: 60px;
      height: 60px;
      border-radius: 6px;
      overflow: hidden;
      background: #fff;
      border: 1px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .pesanan-img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 6px;
    }

    .pesanan-product-info {
      flex: 1;
      min-width: 0;
    }

    .pesanan-product-name {
      font-size: 15px;
      font-weight: 600;
      color: #222;
      margin-bottom: 2px;
    }

    .pesanan-product-variant {
      font-size: 13px;
      color: #444;
    }

    .pesanan-product-status-completed {
      color: #22c100;
      font-size: 13px;
      font-weight: bold;
      margin-top: 2px;
    }

    .pesanan-product-price {
      font-weight: 600;
      font-size: 15px;
      color: #d32f2f;
      min-width: 120px;
      text-align: right;
    }

    .pesanan-total {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 15px;
      color: #333;
      font-weight: 500;
      margin-top: 8px;
    }

    .pesanan-total-label {
      font-weight: 500;
      color: #333;
    }

    .pesanan-total-amount {
      font-weight: bold;
      color: #d32f2f;
      font-size: 16px;
    }

    .pesanan-actions {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }

    .pesanan-action-btn {
      background: #fff;
      color: #d2196f;
      border: 1px solid #d2197f;
      border-radius: 4px;
      padding: 6px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }

    .pesanan-action-btn:hover {
      background: #e3f0ff;
      color: #1256a3;
    }

    .pesanan-action-btn-active {
      background: #1976d2;
      color: #fff;
      border: 1px solid #1976d2;
    }

    .pesanan-action-btn-active:hover {
      background: #1256a3;
      color: #fff;
    }

    .pesanan-kosong {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .no-orders-icon {
      width: 80px;
      height: 80px;
      opacity: 0.3;
      margin-bottom: 20px;
    }

    .pesanan-kosong h3 {
      font-size: 24px;
      color: #333;
      margin-bottom: 12px;
    }

    .pesanan-kosong p {
      font-size: 16px;
      color: #666;
      margin-bottom: 24px;
    }

    .btn-belanja {
      background: #d2197f;
      color: white;
      border: none;
      border-radius: 6px;
      padding: 12px 24px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
    }

    .btn-belanja:hover {
      background: #a31267;
    }

    /* Custom Modal Styling (for rating and chat) */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .modal-overlay.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background-color: #fff;
      padding: 2rem;
      border-radius: 0.75rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      text-align: center;
      max-width: 400px;
      width: 90%;
      transform: translateY(-20px);
      opacity: 0;
      transition: transform 0.3s ease, opacity 0.3s ease;
    }

    /* For the chat modal, we need a larger max-width */
    #chatModal .modal-content {
      max-width: 800px;
      /* Adjust as needed */
      text-align: left;
      /* Align text left for chat */
      padding: 0;
      /* Remove padding from modal content itself, content inside will have padding */
    }


    .modal-overlay.show .modal-content {
      transform: translateY(0);
      opacity: 1;
    }

    .modal-buttons {
      display: flex;
      justify-content: space-around;
      margin-top: 1.5rem;
      gap: 1rem;
    }

    .modal-buttons button {
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s, border-color 0.2s;
    }

    .modal-buttons .btn-cancel {
      background-color: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
    }

    .modal-buttons .btn-cancel:hover {
      background-color: #e0e0e0;
    }

    .modal-buttons .btn-confirm {
      background-color: #ef4444;
      /* Red color for confirm */
      color: white;
      border: 1px solid #ef4444;
    }

    .modal-buttons .btn-confirm:hover {
      background-color: #dc2626;
    }

    .modal-buttons .btn-confirm.success {
      background-color: #22c55e;
      /* Green for success */
      border-color: #22c55e;
    }

    .modal-buttons .btn-confirm.success:hover {
      background-color: #16a34a;
    }

    .chat-contact.active {
      background-color: #fce7f3;
      /* Pink-100 */
      border-color: #fbcfe8;
      /* Pink-200 */
    }
  </style>
</head>

<body class="font-sans bg-gray-100 m-0">
  <header class="bg-white shadow-md py-1 px-6 flex justify-between items-center fixed w-full top-0 z-50 mb-8">
    <div class="flex items-center space-x-3">
      <img src="asset/images/titipgo_logo_remove.png" alt="Logo TitipGo" class="w-28 sm:w-32">
      <div class="relative hidden md:block">
        <input type="text" placeholder="Cari Barang..."
          class="header-search pl-10 pr-4 py-2 border border-gray-300 rounded-full w-56 lg:w-64 focus:outline-none focus:border-pink-500">
        <svg class="w-5 h-5 absolute left-2.5 top-2.5 text-gray-500 pointer-events-none" fill="currentColor"
          viewBox="0 0 20 20">
          <path d="M8 4a4 4 0 104 4 4 4 0 00-4-4zM2 8a6 6 0 1110.39 3.94l4.3 4.3-1.42 1.42-4.3-4.3A6 6 0 012 8z" />
        </svg>
      </div>
    </div>
    <nav class="nav-center flex-grow hidden md:flex justify-center items-center gap-6">
    </nav>
    <nav class="flex items-center space-x-4 sm:space-x-6">
      <a href="pembeli_dashboard.html"
        class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Beranda</a>
      <div class="dropdown-kategori relative inline-block hidden md:block">
        <a href="pembeli_kategori.html"
          class="hidden md:block text-gray-700 hover:text-pink-600 font-semibold text-base">Kategori</a>
        <div class="dropdown-kategori relative inline-block hidden md:block"></div>
      </div>

      <a href="pembeli_keranjang.html" class="relative p-2 text-gray-700 hover:text-pink-600">
        <svg class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z">
          </path>
        </svg>
      </a>
      <a href="pembeli_notifikasi.html" class="relative p-2 text-gray-700 hover:text-pink-600"> <svg
          class="icon-nav w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"
          xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9">
          </path>
        </svg>
      </a>
      <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="User" class="icon-nav w-6 h-6" id="userIcon"
        style="cursor:pointer;">
      <div id="userDropdown"
        class="hidden absolute right-0 top-[60px] bg-white shadow-lg rounded min-w-[160px] z-[1001]">
        <a href="pembeli_akun.html"
          class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Akun Saya</a>
        <a href="pembeli_pesanan_saya.html"
          class="block px-5 py-3 text-gray-900 no-underline text-sm border-b border-gray-100">Pesanan</a>
        <a href="#" onclick="openChatCS();return false;"
          class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Chat dengan
          CS</a>
        <a href="#" onclick="openChatCS();return false;"
          class="block px-5 py-3 text-gray-700 no-underline text-sm border-b border-gray-100">Toko Saya</a>
        <a href="#" onclick="logoutUser();return false;"
          class="block px-5 py-3 text-red-600 no-underline text-sm">Logout</a>
      </div>
    </nav>
  </header>
  <main class="pt-32">
    <h1 class="page-title"
      style="text-align:center;font-size:2rem;font-weight:bold;margin:32px 0 16px 0;letter-spacing:1px;">PESANAN
      SAYA
    </h1>

    <div class="akun-main">
      <div class="akun-sidebar">
        <div class="akun-user-info">
          <img src="https://cdn-icons-png.flaticon.com/512/747/747376.png" alt="User" class="akun-user-icon">
          <div class="akun-user-details">
            <div class="akun-username" id="sidebar-username">Memuat...</div>
          </div>
        </div>

        <div class="akun-menu">
          <a href="pembeli_akun.html" class="akun-menu-item">Akun Saya</a>
          <a href="pembeli_pesanan_saya.html" class="akun-menu-item active">Pesanan Saya</a>
          <a href="#" class="akun-menu-item">Notifikasi</a>
        </div>
      </div>

      <div class="bg-white rounded-xl shadow-lg max-w-4xl w-full mx-auto p-6 mt-6">
        <div class="pesanan-tabs">
          <a href="#" class="pesanan-tab active" data-status="Semua">Semua</a>
          <a href="#" class="pesanan-tab" data-status="Belum Dibayar">Belum Dibayar</a>
          <a href="#" class="pesanan-tab" data-status="Menunggu Verifikasi">Menunggu Verifikasi <span
              class="pesanan-count hidden">(0)</span></a>
          <a href="#" class="pesanan-tab" data-status="Dikirim">Dikirim</a>
          <a href="#" class="pesanan-tab" data-status="Selesai">Selesai</a>
          <a href="#" class="pesanan-tab" data-status="Dibatalkan">Dibatalkan</a>
        </div>

        <h2 class="pesanan-section-title">Semua Pesanan</h2>

        <div id="orders-list" class="mt-6">
          <div class="text-gray-500 text-center py-8">Memuat pesanan...</div>
        </div>
      </div>
    </div>

    <div id="ratingModal" class="modal-overlay">
      <div class="modal-content">
        <h2 class="text-2xl font-bold text-center mb-6">Nilai Produk</h2>
        <div class="flex items-center gap-4 bg-gray-100 rounded p-4 mb-6">
          <img id="rating-product-image" src="https://placehold.co/60x60/E0E0E0/333333?text=Produk" alt="Produk"
            class="w-16 h-16 rounded object-cover border border-gray-300">
          <div>
            <div id="rating-product-name" class="font-semibold text-base"></div>
            <div id="rating-order-number" class="text-xs text-gray-500"></div>
            <div id="rating-order-status" class="text-xs text-pink-600 font-semibold"></div>
          </div>
        </div>
        <form id="ratingForm" class="space-y-6">
          <div>
            <label class="block font-semibold mb-1">Nilai Produk</label>
            <div class="flex gap-1 text-2xl" id="stars-produk">
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
            </div>
          </div>
          <div>
            <label class="block font-semibold mb-1">Layanan Jastiper</label>
            <div class="flex gap-1 text-2xl" id="stars-jastiper">
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
            </div>
          </div>
          <div>
            <label class="block font-semibold mb-1">Jasa Kirim</label>
            <div class="flex gap-1 text-2xl" id="stars-kirim">
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
              <span class="star cursor-pointer">☆</span>
            </div>
          </div>
          <div class="flex justify-between mt-8">
            <button type="button" onclick="hideRatingModal()"
              class="px-6 py-2 rounded bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300">Kembali</button>
            <button type="submit"
              class="px-6 py-2 rounded bg-pink-600 text-white font-semibold hover:bg-pink-700">Kirim</button>
          </div>
        </form>
      </div>
    </div>

    <div id="chatModal" class="modal-overlay">
      <div class="modal-content">
        <div class="flex border-b border-gray-300 items-center justify-between px-4 py-2">
          <span class="font-bold text-lg">Chat</span>
          <button onclick="hideChatModal()"
            class="text-gray-500 hover:text-pink-600 text-2xl leading-none">&times;</button>
        </div>
        <div class="flex h-[320px]">
          <div id="chat-contacts-sidebar"
            class="w-1/3 border-r border-gray-200 p-3 flex flex-col gap-2 bg-gray-50 overflow-y-auto">
            <div class="text-sm text-gray-500 text-center py-2">Memuat kontak...</div>
          </div>
          <div class="flex-1 flex flex-col">
            <div class="p-3 border-b border-gray-200 font-semibold" id="chat-header-title">Pilih kontak untuk memulai
              chat</div>
            <div class="p-3 flex items-center gap-3 border-b border-gray-200 hidden" id="chat-product-info">
              <img id="chat-product-image" src="https://placehold.co/48x48/E0E0E0/333333?text=Produk"
                class="w-12 h-12 rounded border border-gray-300" />
              <div>
                <div id="chat-product-name" class="font-medium text-sm"></div>
                <div id="chat-order-number" class="text-xs text-gray-500"></div>
                <div id="chat-order-status" class="text-xs text-pink-600 font-semibold"></div>
              </div>
            </div>
            <div class="flex-1 p-3 overflow-y-auto" id="chat-messages-container">
              <div class="text-gray-500 text-center py-4">Pilih kontak untuk melihat riwayat chat.</div>
            </div>
            <div class="border-t border-gray-200 p-2 flex items-center">
              <input type="text" id="chat-input" class="flex-1 border-none focus:ring-0 text-sm"
                placeholder="Tulis Pesan" />
              <button class="ml-2 text-pink-600 font-semibold hover:underline" onclick="sendMessage()">Kirim</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-blue-900 py-8 px-6 mt-8">
    <div class="container mx-auto flex flex-wrap justify-between items-start text-white text-sm">
      <div class="w-full sm:w-1/3 mb-6 sm:mb-0">
        <h3 class="font-bold text-white mb-3">INFORMASI</h3>
        <ul>
          <li class="mb-2"><a href="pembeli_tentang_kami.html" class="hover:text-pink-600">Tentang Kami</a></li>
          <li class="mb-2"><a href="pembeli_pertanyaan_umum.html" class="hover:text-pink-600">Pertanyaan Umum</a></li>
          <li class="mb-2"><a href="pembeli_hubungi_kami.html" class="hover:text-pink-600">Hubungi Kami</a></li>
        </ul>
      </div>
      <div class="w-full sm:w-1/3 flex justify-center items-center mb-6 sm:mb-0">
        <img src="asset/images/titipgo_logo_remove.png" alt="TitipGo Logo" class="w-32">
      </div>
      <div class="w-full sm:w-1/3 text-right">
        <h3 class="font-bold text-white mb-3">IKUTI SOSIAL MEDIA KAMI</h3>
        <ul>
          <li class="mb-2 flex items-center justify-end"><i class="fab fa-instagram mr-2"></i><a
              href="https://www.instagram.com/restiidr_?igsh=MXkwbXQ5OHgxdnJteQ%3D%3D&utm_source=qr" target="_blank"
              class="hover:text-pink-600">Instagram</a></li>
          <li class="mb-2 flex items-center justify-end"><i class="fab fa-facebook mr-2"></i><a
              href="https://www.instagram.com/sitiiwhy_?igsh=MTk4aWtnbTBmaWZyZQ==" target="_blank"
              class="hover:text-pink-600">Facebook</a></li>
          <li class="mb-2 flex items-center justify-end"><i class="fab fa-youtube mr-2"></i><a
              href="https://www.instagram.com/okay_5527?igsh=MXVkODNpNTNrZ3kwbg==" target="_blank"
              class="hover:text-pink-600">Youtube</a></li>
        </ul>
      </div>
    </div>
    <div class="text-center text-white text-xs mt-8 opacity-75"> © 2025 TitipGo. All rights reserved.
    </div>
  </footer>

  <script type="module">
    // Import Firebase functions from firebase-config.js
    import {
      auth,
      db,
      onAuthStateChanged,
      doc,
      getDoc,
      updateDoc,
      signOut,
      collection,
      query,
      where,
      getDocs,
      addDoc,
      serverTimestamp
    } from './js/firebase-config.js'; // Corrected path to firebase-config.js

    let currentUserId = null;
    let allOrders = []; // To store all fetched orders
    let currentTab = 'Semua'; // Default active tab
    let currentChatPartnerId = null; // Store the UID of the person being chatted with
    let currentChatOrderId = null; // Store the order ID associated with the current chat

    // DOM Elements
    const sidebarUsername = document.getElementById('sidebar-username');
    const ordersListContainer = document.getElementById('orders-list');
    const pesananTabs = document.querySelectorAll('.pesanan-tab');
    const pesananSectionTitle = document.querySelector('.pesanan-section-title');
    const pendingOrdersCountSpan = document.querySelector('.pesanan-tab[data-status="Menunggu Verifikasi"] .pesanan-count');

    // Header dropdown elements
    const userIcon = document.getElementById('userIcon');
    const userDropdown = document.getElementById('userDropdown');

    // Rating Modal Elements
    const ratingModal = document.getElementById('ratingModal');
    const ratingProductImage = document.getElementById('rating-product-image');
    const ratingProductName = document.getElementById('rating-product-name');
    const ratingOrderNumber = document.getElementById('rating-order-number');
    const ratingOrderStatus = document.getElementById('rating-order-status');
    const ratingForm = document.getElementById('ratingForm');
    let currentRatingOrderId = null; // To store the order ID for rating

    // Chat Modal Elements
    const chatModal = document.getElementById('chatModal');
    const chatContactsSidebar = document.getElementById('chat-contacts-sidebar');
    const chatHeaderTitle = document.getElementById('chat-header-title');
    const chatProductInfo = document.getElementById('chat-product-info');
    const chatProductImage = document.getElementById('chat-product-image');
    const chatProductName = document.getElementById('chat-product-name');
    const chatOrderNumber = document.getElementById('chat-order-number');
    const chatOrderStatus = document.getElementById('chat-order-status');
    const chatMessagesContainer = document.getElementById('chat-messages-container');
    const chatInput = document.getElementById('chat-input');


    // --- Helper Functions ---

    // Function to format currency to IDR
    function formatRupiah(amount) {
      return new Intl.NumberFormat("id-ID", {
        style: "currency",
        currency: "IDR",
        minimumFractionDigits: 0,
      }).format(amount);
    }

    // Function to show custom confirmation/alert modal (re-used from admin-katalog.html for consistency)
    function showCustomAlert(message) {
      alert(message);
    }

    // --- Firebase Data Fetching ---

    // Fetch user data for sidebar
    async function fetchUserData(uid) {
      try {
        const userDocRef = doc(db, "users", uid);
        const userDocSnap = await getDoc(userDocRef);

        if (userDocSnap.exists()) {
          const userData = userDocSnap.data();
          sidebarUsername.textContent = userData.username || userData.namaLengkap || 'Pengguna';
        } else {
          console.warn("Dokumen pengguna tidak ditemukan di Firestore.");
          showCustomAlert("Data profil Anda tidak ditemukan. Silakan lengkapi profil Anda.");
        }
      } catch (error) {
        console.error("Error fetching user data:", error);
        showCustomAlert("Gagal memuat data profil: " + error.message);
      }
    }

    // Fetch orders based on status filter
    async function fetchOrdersFromFirestore(statusFilter = 'Semua') {
      if (!currentUserId) {
        ordersListContainer.innerHTML = '<div class="text-gray-500 text-center py-8">Silakan login untuk melihat pesanan Anda.</div>';
        return;
      }

      ordersListContainer.innerHTML = '<div class="text-gray-500 text-center py-8">Memuat pesanan...</div>';

      // Update section title based on filter
      pesananSectionTitle.textContent = `Pesanan ${statusFilter}`;


      try {
        let q;
        if (statusFilter === 'Semua') {
          // PERBAIKAN DI SINI: Ubah "pembeliId" menjadi "userId"
          q = query(collection(db, "orders"), where("userId", "==", currentUserId));
        } else {
          // PERBAIKAN DI SINI: Ubah "pembeliId" menjadi "userId"
          q = query(collection(db, "orders"), where("userId", "==", currentUserId), where("status", "==", statusFilter));
        }

        const querySnapshot = await getDocs(q);
        allOrders = []; // Clear previous orders
        let pendingCount = 0;

        querySnapshot.forEach((doc) => {
          const orderData = {
            id: doc.id,
            ...doc.data()
          };
          allOrders.push(orderData);
          if (orderData.status === 'Menunggu Verifikasi') { // Perbaikan: Gunakan status yang sesuai
            pendingCount++;
          }
        });

        // Sort orders by creation date (newest first)
        allOrders.sort((a, b) => (b.timestamp?.toDate() || 0) - (a.timestamp?.toDate() || 0));

        renderOrders(); // Render filtered orders
        updatePendingOrdersCount(pendingCount);

      } catch (error) {
        console.error("Error loading orders from Firestore:", error);
        ordersListContainer.innerHTML = `<div class="text-red-500 text-center py-8">Gagal memuat pesanan: ${error.message}</div>`;
      }
    }

    // Fetch store name for a given storeId
    async function getStoreName(storeId) {
      if (!storeId) return "Toko Tidak Diketahui";
      try {
        const storeDocRef = doc(db, "toko", storeId);
        const storeDocSnap = await getDoc(storeDocRef);
        if (storeDocSnap.exists()) {
          return storeDocSnap.data().namaToko || "Toko Tidak Diketahui";
        }
        return "Toko Tidak Ditemukan";
      } catch (error) {
        console.error("Error fetching store name:", error);
        return "Error Memuat Toko";
      }
    }

    // --- Rendering Functions ---

    async function renderOrders() {
      if (allOrders.length === 0) {
        ordersListContainer.innerHTML = `<div class="pesanan-kosong">
                    <img src="https://cdn-icons-png.flaticon.com/512/263/263142.png" alt="No Orders" class="no-orders-icon">
                    <h3>Tidak ada pesanan</h3>
                    <p>Belum ada pesanan dengan status ini.</p>
                    <button class="btn-belanja" onclick="window.location.href='pembeli_dashboard.html'">Mulai Belanja</button>
                </div>`;
        return;
      }

      const orderHtmlPromises = allOrders.map(async (order) => {
        const storeName = await getStoreName(order.tokoId); // Assuming tokoId is present in order
        let actionButtons = '';
        const orderIndex = allOrders.indexOf(order); // Get current index for local array manipulation (if needed)

        // Perbaikan: Menggunakan 'order.items' dan properti 'quantity' dan 'variant'
        const firstProduct = order.items && order.items.length > 0 ? order.items[0] : null;
        const productNameForChat = firstProduct ? (firstProduct.namaBarang || '') : '';
        const productImageForChat = firstProduct ? (firstProduct.imageUrl || '') : '';

        if (order.status === 'Belum Dibayar') {
          actionButtons = `
                                <button class="pesanan-action-btn pesanan-action-btn-active" onclick="window.location.href='pembeli_pembayaran.html?orderId=${order.id}'">Bayar Sekarang</button>
                                <button class="pesanan-action-btn" onclick="showChatModalWithOrder('${order.id}', '${order.jastiperId}', '${productNameForChat}', '${productImageForChat}', '${order.status}')">Hubungi Penjual</button>
                            `;
        } else if (order.status === 'Menunggu Verifikasi') { // Perbaikan: Sesuaikan dengan status di database
          actionButtons = `
                                <button class="pesanan-action-btn pesanan-action-btn-active" disabled>Menunggu Verifikasi Penjual</button>
                                <button class="pesanan-action-btn" onclick="showChatModalWithOrder('${order.id}', '${order.jastiperId}', '${productNameForChat}', '${productImageForChat}', '${order.status}')">Hubungi Penjual</button>
                            `;
        } else if (order.status === 'Dikirim') {
          actionButtons = `
                                <button class="pesanan-action-btn pesanan-action-btn-active" onclick="markOrderCompleted('${order.id}')">Pesanan Selesai</button>
                                <button class="pesanan-action-btn" onclick="showChatModalWithOrder('${order.id}', '${order.jastiperId}', '${productNameForChat}', '${productImageForChat}', '${order.status}')">Hubungi Penjual</button>
                            `;
        } else if (order.status === 'Selesai') {
          actionButtons = `
                                <button class="pesanan-action-btn pesanan-action-btn-active" onclick="showRatingModalWithOrder('${order.id}', '${productNameForChat}', '${productImageForChat}', '${order.status}')">Nilai</button>
                                <button class="pesanan-action-btn" onclick="showChatModalWithOrder('${order.id}', '${order.jastiperId}', '${productNameForChat}', '${productImageForChat}', '${order.status}')">Hubungi Penjual</button>
                            `;
        } else {
          // Default action for other statuses like 'Dibatalkan'
          actionButtons = `<button class="pesanan-action-btn" onclick="showChatModalWithOrder('${order.id}', '${order.jastiperId}', '${productNameForChat}', '${productImageForChat}', '${order.status}')">Hubungi Penjual</button>`;
        }

        // Calculate total price for all products in the order
        // Perbaikan: Pastikan order.items adalah array sebelum memanggil reduce, dan gunakan product.quantity
        const totalOrderPrice = (order.items || []).reduce((sum, product) => {
          return sum + (product.harga || 0) * (product.quantity || 1);
        }, 0);

        return `
                        <div class="border border-gray-300 rounded bg-white mt-2 mb-8">
                            <div class="flex justify-between items-center px-4 py-2 border-b border-gray-200">
                                <div class="flex items-center gap-2">
                                    <span class="font-bold text-base">${storeName}</span>
                                    <button class="px-2 py-1 border border-pink-600 rounded bg-pink-600 text-white text-xs hover:bg-pink-700 hover:border-pink-700 ml-2" onclick="kunjungiToko('${order.tokoId}')">Kunjungi Toko</button>
                                </div>
                                <span class="text-sm font-semibold text-pink-600">${order.status}</span>
                            </div>
                            <div class="p-4">
                                ${order.items.map(item => `
                                    <div class="pesanan-product">
                                        <div class="pesanan-product-image">
                                            <img src="${item.imageUrl || 'https://placehold.co/60x60/E0E0E0/333333?text=Produk'}" alt="${item.namaBarang}" class="pesanan-img" onerror="this.onerror=null;this.src='https://placehold.co/60x60/E0E0E0/333333?text=Produk';">
                                        </div>
                                        <div class="pesanan-product-info">
                                            <div class="pesanan-product-name">${item.namaBarang}</div>
                                            ${item.variant ? `<div class="pesanan-product-variant">${item.variant}</div>` : ''}
                                            <div class="pesanan-product-variant">Jumlah: ${item.quantity}</div>
                                        </div>
                                        <div class="pesanan-product-price">${formatRupiah(item.harga * item.quantity)}</div>
                                    </div>
                                `).join('')}
                            </div>
                            <div class="flex justify-end items-center px-4 py-3 border-t border-gray-200">
                                <div class="pesanan-total">
                                    <span class="pesanan-total-label">Total Pesanan:</span>
                                    <span class="pesanan-total-amount">${formatRupiah(totalOrderPrice)}</span>
                                </div>
                            </div>
                            <div class="pesanan-actions px-4 pb-3">
                                ${actionButtons}
                            </div>
                        </div>
                    `;
      });

      const orderHtml = await Promise.all(orderHtmlPromises);
      ordersListContainer.innerHTML = orderHtml.join('');
    }

    function updatePendingOrdersCount(count) {
      if (pendingOrdersCountSpan) {
        if (count > 0) {
          pendingOrdersCountSpan.textContent = `(${count})`;
          pendingOrdersCountSpan.classList.remove('hidden');
        } else {
          pendingOrdersCountSpan.classList.add('hidden');
        }
      }
    }

    // --- Event Listeners and Initial Load ---

    // Handle tab clicks
    pesananTabs.forEach(tab => {
      tab.addEventListener('click', (event) => {
        event.preventDefault();
        pesananTabs.forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.status;
        fetchOrdersFromFirestore(currentTab);
      });
    });

    // Handle header dropdown for user icon
    if (userIcon) {
      userIcon.addEventListener('click', function (event) {
        event.preventDefault();
        if (userDropdown) userDropdown.classList.toggle('hidden');
      });
    }

    document.addEventListener('click', function (event) {
      if (userIcon && userDropdown && !userIcon.contains(event.target) && !userDropdown.contains(event.target)) {
        userDropdown.classList.add('hidden');
      }
    });

    // --- Rating Modal Functions ---
    window.showRatingModalWithOrder = async function (orderId, productName, productImage, orderStatus) {
      currentRatingOrderId = orderId;
      ratingProductImage.src = productImage || 'https://placehold.co/60x60/E0E0E0/333333?text=Produk';
      ratingProductName.textContent = productName;
      ratingOrderNumber.textContent = `Order ID: ${orderId}`;
      ratingOrderStatus.textContent = `Status: ${orderStatus}`;

      // Reset stars to empty
      document.querySelectorAll('#stars-produk .star').forEach(star => star.textContent = '☆');
      document.querySelectorAll('#stars-jastiper .star').forEach(star => star.textContent = '☆');
      document.querySelectorAll('#stars-kirim .star').forEach(star => star.textContent = '☆');

      // Add click listeners for stars
      setupStarRating('stars-produk', 'productRating');
      setupStarRating('stars-jastiper', 'jastiperRating');
      setupStarRating('stars-kirim', 'kirimRating');

      ratingModal.classList.add('show');
    };

    window.hideRatingModal = function () {
      ratingModal.classList.remove('show');
      currentRatingOrderId = null;
    };

    let ratings = {
      productRating: 0,
      jastiperRating: 0,
      kirimRating: 0
    };

    function setupStarRating(containerId, ratingKey) {
      const container = document.getElementById(containerId);
      const stars = container.querySelectorAll('.star');
      stars.forEach((star, index) => {
        star.onclick = () => {
          ratings[ratingKey] = index + 1;
          stars.forEach((s, i) => {
            s.textContent = i < ratings[ratingKey] ? '★' : '☆';
          });
        };
      });
    }

    ratingForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      if (!currentRatingOrderId) {
        showCustomAlert("Tidak ada pesanan yang dipilih untuk diberi nilai.");
        return;
      }

      if (ratings.productRating === 0 || ratings.jastiperRating === 0 || ratings.kirimRating === 0) {
        showCustomAlert("Mohon berikan semua nilai bintang.");
        return;
      }

      try {
        // Update the order status to 'Selesai' (if not already) and add rating data
        const orderRef = doc(db, "orders", currentRatingOrderId);
        await updateDoc(orderRef, {
          status: 'Selesai', // Ensure status is 'Selesai' after rating
          rating: {
            product: ratings.productRating,
            jastiper: ratings.jastiperRating,
            kirim: ratings.kirimRating,
            ratedAt: serverTimestamp()
          },
          updatedAt: serverTimestamp()
        });

        // Optionally, update product/jastiper/delivery ratings averages (requires Cloud Functions for security)
        // For now, just confirming the order update.

        showCustomAlert("Terima kasih atas penilaian Anda!");
        hideRatingModal();
        fetchOrdersFromFirestore(currentTab); // Refresh orders list
      } catch (error) {
        console.error("Error submitting rating:", error);
        showCustomAlert("Gagal mengirim penilaian: " + error.message);
      }
    });

    // --- Chat Modal Functions ---

    window.showChatModalWithOrder = async function (orderId, jastiperId, productName, productImage, orderStatus) {
      currentChatOrderId = orderId;
      currentChatPartnerId = jastiperId; // This is the jastiper's UID

      // Update chat header with product/order info
      chatHeaderTitle.textContent = `Chat dengan Jastiper untuk Pesanan: ${orderId}`;
      chatProductInfo.classList.remove('hidden');
      chatProductImage.src = productImage || 'https://placehold.co/48x48/E0E0E0/333333?text=Produk';
      chatProductName.textContent = productName;
      chatOrderNumber.textContent = `Order ID: ${orderId}`;
      chatOrderStatus.textContent = `Status: ${orderStatus}`;

      // Fetch and display chat messages for this order and partner
      await fetchChatMessages();

      chatModal.classList.add('show');
    };

    window.hideChatModal = function () {
      chatModal.classList.remove('show');
      currentChatPartnerId = null;
      currentChatOrderId = null;
      chatMessagesContainer.innerHTML = '<div class="text-gray-500 text-center py-4">Pilih kontak untuk melihat riwayat chat.</div>'; // Clear messages
      chatInput.value = ''; // Clear input
      chatProductInfo.classList.add('hidden'); // Hide product info
    };

    async function fetchChatMessages() {
      if (!currentUserId || !currentChatPartnerId || !currentChatOrderId) {
        chatMessagesContainer.innerHTML = '<div class="text-gray-500 text-center py-4">Pilih kontak untuk melihat riwayat chat.</div>';
        return;
      }

      chatMessagesContainer.innerHTML = '<div class="text-gray-500 text-center py-4">Memuat pesan...</div>';

      try {
        // Chat messages are stored in a subcollection under the order
        // Path: orders/{orderId}/chats/{chatMessageId}
        const chatRef = collection(db, "orders", currentChatOrderId, "chats");
        // Query for messages between current user and current chat partner
        // This assumes each message document has 'senderId' and 'receiverId'
        const q = query(chatRef,
          where("senderId", "in", [currentUserId, currentChatPartnerId]),
          where("receiverId", "in", [currentUserId, currentChatPartnerId]),
          orderBy("timestamp", "asc") // Order by timestamp
        );

        const querySnapshot = await getDocs(q);
        let messagesHtml = '';
        if (querySnapshot.empty) {
          messagesHtml = '<div class="text-gray-500 text-center py-4">Belum ada pesan dalam obrolan ini.</div>';
        } else {
          querySnapshot.forEach(docSnap => {
            const msg = docSnap.data();
            const isSender = msg.senderId === currentUserId;
            const messageClass = isSender ? 'bg-pink-100 self-end text-right' : 'bg-gray-200 self-start text-left';
            messagesHtml += `
              <div class="flex ${isSender ? 'justify-end' : 'justify-start'} mb-2">
                <div class="rounded-lg p-2 max-w-[70%] ${messageClass}">
                  <p class="text-sm">${msg.text}</p>
                  <span class="text-xs text-gray-500">${new Date(msg.timestamp?.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
                </div>
              </div>
            `;
          });
        }
        chatMessagesContainer.innerHTML = messagesHtml;
        chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight; // Scroll to bottom
      } catch (error) {
        console.error("Error fetching chat messages:", error);
        chatMessagesContainer.innerHTML = `<div class="text-red-500 text-center py-4">Gagal memuat pesan: ${error.message}</div>`;
      }
    }

    window.sendMessage = async function () {
      const messageText = chatInput.value.trim();
      if (!messageText || !currentUserId || !currentChatPartnerId || !currentChatOrderId) {
        showCustomAlert("Pesan tidak boleh kosong atau chat belum siap.");
        return;
      }

      try {
        const chatRef = collection(db, "orders", currentChatOrderId, "chats");
        await addDoc(chatRef, {
          senderId: currentUserId,
          receiverId: currentChatPartnerId,
          text: messageText,
          timestamp: serverTimestamp()
        });
        chatInput.value = ''; // Clear input
        await fetchChatMessages(); // Refresh messages
      } catch (error) {
        console.error("Error sending message:", error);
        showCustomAlert("Gagal mengirim pesan: " + error.message);
      }
    };

    // --- Order Actions ---
    window.markOrderCompleted = async function (orderId) {
      showCustomAlert("Fungsi 'Pesanan Selesai' belum diimplementasikan.", null, false);
      // Implement logic to update order status to 'Selesai' in Firestore
      // You might also want to trigger a Cloud Function here to handle finalization,
      // such as releasing funds to the jastiper.
    };

    window.kunjungiToko = function (storeId) {
      showCustomAlert(`Fungsi 'Kunjungi Toko' untuk ID: ${storeId} belum diimplementasikan.`);
      // Implement redirection to store page
    };


    // --- General Navigation / Logout (re-used from other files) ---
    window.logoutUser = async function () {
      showCustomAlert("Anda yakin ingin logout?", async () => {
        try {
          await signOut(auth);
          showCustomAlert("Anda telah logout!");
          window.location.href = 'pembeli_login.html'; // Redirect to login page after logout
        } catch (error) {
          console.error("Error during logout:", error);
          showCustomAlert("Gagal logout. Silakan coba lagi.");
        }
      });
    };

    window.openChatCS = function () {
      showCustomAlert("Fungsi Chat dengan CS belum diimplementasikan.");
    };

    window.openTokoSaya = async function () {
      if (!currentUserId) {
        showCustomAlert("Anda harus login untuk mengakses Toko Saya.");
        window.location.href = 'pembeli_login.html';
        return;
      }

      try {
        const tokoQuery = query(collection(db, "toko"), where("ownerId", "==", currentUserId));
        const tokoSnap = await getDocs(tokoQuery);

        if (!tokoSnap.empty) {
          const tokoDoc = tokoSnap.docs[0];
          window.location.href = `jastiper_dashboard.html?storeId=${tokoDoc.id}`;
        } else {
          showCustomAlert("Anda belum memiliki toko. Apakah Anda ingin membuat toko?", () => {
            showCustomAlert("Fungsi pembuatan toko belum diimplementasikan.");
          });
        }
      } catch (error) {
        console.error("Error checking store ownership:", error);
        showCustomAlert("Gagal memeriksa status toko Anda. Silakan coba lagi.");
      }
    };


    // Initial authentication check and data load
    document.addEventListener('DOMContentLoaded', () => {
      onAuthStateChanged(auth, (user) => {
        if (user) {
          currentUserId = user.uid;
          console.log("User is logged in:", currentUserId);
          fetchUserData(currentUserId); // Fetch user data for sidebar
          fetchOrdersFromFirestore(currentTab); // Load orders for the current tab
        } else {
          currentUserId = null;
          console.log("User is not logged in.");
          showCustomAlert("Anda harus login untuk melihat pesanan Anda.");
          window.location.href = 'pembeli_login.html';
        }
      });
    });
  </script>
</body>

</html>